<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Planner - Feature Detection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes popIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes countUp {
            0% {
                transform: translateY(10px) scale(1.5);
                opacity: 0;
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .slide-up {
            animation: slideUp 0.5s ease-out;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        .pulse-animate {
            animation: pulse 2s infinite;
        }

        .pop-in {
            animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .count-up {
            animation: countUp 0.4s ease-out;
        }

        .feature-badge {
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .scroll-smooth {
            scroll-behavior: smooth;
        }

        .mini-plan-card {
            transition: all 0.3s ease;
        }

        .mini-plan-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(139, 92, 246, 0.3);
        }

        .step-item {
            animation: slideUp 0.4s ease-out;
            animation-fill-mode: both;
        }

        .feature-panel {
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen">
    <div id="app" class="min-h-screen"></div>

    <script>
        let state = {
            isAuthenticated: false,
            showLogin: true,
            username: '',
            password: '',
            email: '',
            currentUser: null,
            aim: '',
            steps: { step1: '', step2: '' },
            phase: 'input',
            apiResponse: null,
            isLoading: false,
            // Enhanced real-time tracking
            realtimeEvents: [],
            currentPhase: null,
            agentProgress: {},
            liveAgentPlans: {},
            analyticsData: {},
            eventSource: null,
            // üÜï Feature Detection
            discoveredFeatures: [],
            featureCount: 0,
            newFeatureAnimation: null
        };

        function setState(updates) {
            const needsFullRender = 
                updates.hasOwnProperty('isAuthenticated') ||
                updates.hasOwnProperty('showLogin') ||
                updates.hasOwnProperty('phase');
            
            state = { ...state, ...updates };
            
            if (needsFullRender) {
                render();
            }
        }

        async function startPlanning() {
            setState({ 
                isLoading: true, 
                phase: 'processing',
                realtimeEvents: [],
                agentProgress: {},
                liveAgentPlans: {},
                analyticsData: {},
                discoveredFeatures: [],
                featureCount: 0
            });

            try {
                const response = await fetch('http://localhost:5000/api/plan/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: state.currentUser,
                        aim: state.aim,
                        steps: state.steps
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const eventData = JSON.parse(line.substring(6));
                            handleRealtimeEvent(eventData);
                        }
                    }
                }

            } catch (error) {
                console.error('Streaming error:', error);
                alert('Planning failed: ' + error.message);
                setState({ phase: 'input', isLoading: false });
            }
        }

        function parseStepsFromPlan(planText) {
            if (!planText) return [];
            
            const steps = [];
            const lines = planText.split('\n');
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed && (
                    trimmed.startsWith('-') || 
                    trimmed.startsWith('‚Ä¢') || 
                    /^\d+\./.test(trimmed) ||
                    /^step\s*\d+/i.test(trimmed)
                )) {
                    let step = trimmed
                        .replace(/^[-‚Ä¢]/, '')
                        .replace(/^\d+\./, '')
                        .replace(/^step\s*\d+:?/i, '')
                        .trim();
                    
                    if (step) {
                        steps.push(step);
                    }
                }
            }
            
            return steps;
        }

        function handleRealtimeEvent(event) {
            console.log('Real-time event:', event);
            state.realtimeEvents.push(event);

            const timestamp = new Date();

            switch(event.type) {
                case 'connected':
                    addLogMessage('‚úÖ Connected to AI Planning System', 'success');
                    break;

                case 'process_start':
                    addLogMessage(`üöÄ Starting planning for ${event.data.agents_count} AI agents`, 'info');
                    state.analyticsData.processStartTime = timestamp;
                    break;

                case 'feature_detection_start':
                    addLogMessage('üîç Starting feature detection...', 'feature');
                    break;

                case 'features_detected':
                    handleFeatureDetection(event.data);
                    break;

                case 'phase_start':
                    state.currentPhase = event.data.phase;
                    addLogMessage(`üìç Phase ${event.data.phase}: ${event.data.description}`, 'info');
                    updateProcessingDisplay();
                    break;

                case 'agent_start':
                    addLogMessage(`ü§ñ ${event.data.agent.toUpperCase()} - Starting plan generation`, 'agent');
                    state.liveAgentPlans[event.data.agent] = {
                        status: 'generating',
                        mini_plans: [],
                        final_plan: null,
                        steps: [],
                        score: null,
                        startTime: timestamp,
                        parameters_used: []
                    };
                    updateAgentProgress(event.data.agent, 'generating', 0);
                    updateLivePlansDisplay();
                    break;

                case 'mini_plan_start':
                    addLogMessage(`  üîç ${event.data.agent.toUpperCase()} - Processing group ${event.data.group}/${event.data.total_groups}`, 'progress');
                    
                    if (state.liveAgentPlans[event.data.agent]) {
                        const miniPlanData = {
                            group: event.data.group,
                            startTime: timestamp,
                            status: 'processing',
                            parameters: event.data.parameters || []
                        };
                        
                        if (!state.liveAgentPlans[event.data.agent].current_mini_plan) {
                            state.liveAgentPlans[event.data.agent].current_mini_plan = miniPlanData;
                        }
                    }
                    
                    updateAgentProgress(event.data.agent, 'generating', event.data.progress);
                    updateLivePlansDisplay();
                    break;

                case 'mini_plan_complete':
                    const completionTime = timestamp;
                    const agent = event.data.agent;
                    
                    addLogMessage(`  ‚úÖ ${agent.toUpperCase()} - Group ${event.data.group} completed`, 'success');
                    
                    if (state.liveAgentPlans[agent]) {
                        const miniPlan = state.liveAgentPlans[agent].current_mini_plan || {};
                        const duration = miniPlan.startTime ? 
                            ((completionTime - miniPlan.startTime) / 1000).toFixed(2) : 0;
                        
                        const completedMiniPlan = {
                            group: event.data.group,
                            preview: event.data.mini_plan,
                            steps: parseStepsFromPlan(event.data.mini_plan),
                            startTime: miniPlan.startTime || completionTime,
                            endTime: completionTime,
                            duration: duration,
                            parameters: event.data.parameters || miniPlan.parameters || [],
                            status: 'completed'
                        };
                        
                        state.liveAgentPlans[agent].mini_plans.push(completedMiniPlan);
                        state.liveAgentPlans[agent].current_mini_plan = null;
                    }
                    
                    updateAgentProgress(event.data.agent, 'generating', event.data.progress);
                    updateLivePlansDisplay();
                    scrollToLatestMiniPlan(agent);
                    break;

                case 'summarizing':
                    addLogMessage(`  üìã ${event.data.agent.toUpperCase()} - Summarizing ${event.data.mini_plans_count} mini-plans`, 'info');
                    if (state.liveAgentPlans[event.data.agent]) {
                        state.liveAgentPlans[event.data.agent].status = 'summarizing';
                    }
                    updateLivePlansDisplay();
                    break;

                case 'agent_complete':
                    addLogMessage(`  üéâ ${event.data.agent.toUpperCase()} - Plan complete! Score: ${event.data.score}/100`, 'success');
                    
                    if (state.liveAgentPlans[event.data.agent]) {
                        const agentData = state.liveAgentPlans[event.data.agent];
                        agentData.final_plan = event.data.plan;
                        agentData.steps = parseStepsFromPlan(event.data.plan);
                        agentData.score = event.data.score;
                        agentData.status = 'complete';
                        agentData.endTime = timestamp;
                        
                        const totalDuration = agentData.startTime ? 
                            ((timestamp - agentData.startTime) / 1000).toFixed(2) : 0;
                        agentData.totalDuration = totalDuration;
                    }
                    
                    updateAgentProgress(event.data.agent, 'complete', 100, event.data.score);
                    updateLivePlansDisplay();
                    break;

                case 'improvement_chain_start':
                    addLogMessage(`üîÑ Starting improvement chain for ${event.data.original_agent.toUpperCase()}`, 'info');
                    if (state.liveAgentPlans[event.data.original_agent]) {
                        state.liveAgentPlans[event.data.original_agent].status = 'improving';
                        state.liveAgentPlans[event.data.original_agent].improvements = [];
                    }
                    updateLivePlansDisplay();
                    break;

                case 'improvement_start':
                    addLogMessage(`  üîß ${event.data.improving_agent.toUpperCase()} improving ${event.data.original_agent.toUpperCase()}'s plan (${event.data.step}/${event.data.total_steps})`, 'progress');
                    break;

                case 'improvement_complete':
                    addLogMessage(`  ‚ú® ${event.data.improving_agent.toUpperCase()} improved to score: ${event.data.score}`, 'success');
                    
                    if (state.liveAgentPlans[event.data.original_agent]) {
                        const improvement = {
                            by_agent: event.data.improving_agent,
                            step: event.data.step,
                            score: event.data.score,
                            plan_preview: event.data.plan_preview,
                            steps: parseStepsFromPlan(event.data.plan_preview),
                            timestamp: timestamp
                        };
                        
                        if (!state.liveAgentPlans[event.data.original_agent].improvements) {
                            state.liveAgentPlans[event.data.original_agent].improvements = [];
                        }
                        state.liveAgentPlans[event.data.original_agent].improvements.push(improvement);
                    }
                    
                    updateAgentProgress(event.data.original_agent, 'improving', 
                        (event.data.step / 11) * 100, event.data.score);
                    updateLivePlansDisplay();
                    break;

                case 'improvement_chain_complete':
                    addLogMessage(`  üèÅ ${event.data.original_agent.toUpperCase()} - Final score: ${event.data.final_score} (avg: ${event.data.average_score.toFixed(1)})`, 'success');
                    
                    if (state.liveAgentPlans[event.data.original_agent]) {
                        state.liveAgentPlans[event.data.original_agent].final_score = event.data.final_score;
                        state.liveAgentPlans[event.data.original_agent].average_score = event.data.average_score;
                        state.liveAgentPlans[event.data.original_agent].all_scores = event.data.all_scores;
                        state.liveAgentPlans[event.data.original_agent].status = 'improved';
                    }
                    updateLivePlansDisplay();
                    break;

                case 'process_complete':
                    addLogMessage(`üéä Planning complete! ${event.data.total_agents} agents finished`, 'success');
                    state.analyticsData.processEndTime = timestamp;
                    setState({ 
                        apiResponse: event.data.result,
                        phase: 'results',
                        isLoading: false
                    });
                    break;

                case 'error':
                    addLogMessage(`‚ùå Error: ${event.data.message}`, 'error');
                    setState({ phase: 'input', isLoading: false });
                    break;
            }
        }

        function handleFeatureDetection(data) {
            const newCount = data.added_count || 0;
            const source = data.source || 'unknown';
            
            if (newCount > 0) {
                // Update feature list
                state.discoveredFeatures = data.all_features || [];
                state.featureCount = data.total_features || 0;
                
                // Add log message
                addLogMessage(`‚ú® +${newCount} new features detected from ${source}`, 'feature');
                
                // Animate counter
                animateFeatureCounter(newCount);
                
                // Update display
                updateFeaturePanel();
            }
        }

        function animateFeatureCounter(newCount) {
            const counterEl = document.getElementById('featureCounter');
            const addedEl = document.getElementById('featureAdded');
            
            if (counterEl && addedEl) {
                // Show +N animation
                addedEl.textContent = `+${newCount}`;
                addedEl.classList.remove('count-up');
                void addedEl.offsetWidth; // Trigger reflow
                addedEl.classList.add('count-up');
                addedEl.style.opacity = '1';
                
                // Update total count
                counterEl.textContent = state.featureCount;
                
                // Hide +N after animation
                setTimeout(() => {
                    addedEl.style.opacity = '0';
                }, 2000);
            }
        }

        function updateFeaturePanel() {
            const featureList = document.getElementById('featureList');
            if (!featureList) return;
            
            featureList.innerHTML = state.discoveredFeatures.map((feature, index) => `
                <div class="feature-badge bg-gradient-to-r from-purple-500 to-pink-500 bg-opacity-10 border border-purple-500 border-opacity-30 rounded-lg px-4 py-3 mb-2"
                     style="animation-delay: ${index * 0.05}s">
                    <div class="flex items-center gap-2">
                        <span class="text-purple-400 font-bold text-lg">‚Ä¢</span>
                        <span class="text-slate-100 font-medium">${feature}</span>
                    </div>
                </div>
            `).join('');
        }

        function scrollToLatestMiniPlan(agent) {
            setTimeout(() => {
                const container = document.getElementById(`agent-${agent}-plans`);
                if (container) {
                    const cards = container.querySelectorAll('.mini-plan-card');
                    if (cards.length > 0) {
                        cards[cards.length - 1].scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'nearest' 
                        });
                    }
                }
            }, 100);
        }

        function addLogMessage(message, type) {
            const logContainer = document.getElementById('realtimeLog');
            if (logContainer) {
                const colors = {
                    'success': 'text-green-400',
                    'error': 'text-red-400',
                    'info': 'text-blue-400',
                    'agent': 'text-purple-400',
                    'progress': 'text-yellow-400',
                    'feature': 'text-pink-400'
                };

                const logEntry = document.createElement('div');
                logEntry.className = `text-sm ${colors[type] || 'text-slate-300'} mb-1 font-mono fade-in`;
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        function updateAgentProgress(agent, status, progress, score) {
            state.agentProgress[agent] = { status, progress, score };
            updateProgressBars();
        }

        function updateProgressBars() {
            const progressContainer = document.getElementById('agentProgressContainer');
            if (!progressContainer) return;

            const agents = Object.keys(state.agentProgress);
            progressContainer.innerHTML = agents.map(agent => {
                const { status, progress, score } = state.agentProgress[agent];
                const statusEmoji = {
                    'generating': '‚è≥',
                    'improving': 'üîÑ',
                    'complete': '‚úÖ'
                };

                return `
                    <div class="bg-slate-800 bg-opacity-30 rounded-lg p-3 mb-2 slide-up">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold text-purple-300">
                                ${statusEmoji[status] || '‚è≥'} ${agent.toUpperCase()}
                            </span>
                            ${score ? `<span class="text-xs text-green-400 font-bold">Score: ${score}</span>` : ''}
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-2 overflow-hidden">
                            <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all duration-500" 
                                 style="width: ${progress}%"></div>
                        </div>
                        <div class="text-xs text-slate-400 mt-1">${Math.round(progress)}% - ${status}</div>
                    </div>
                `;
            }).join('');
        }

        function updateLivePlansDisplay() {
            const plansContainer = document.getElementById('livePlansContainer');
            if (!plansContainer) return;

            const agents = Object.keys(state.liveAgentPlans);
            plansContainer.innerHTML = agents.map(agent => {
                const planData = state.liveAgentPlans[agent];
                return renderAgentPlanCard(agent, planData);
            }).join('');
        }

        function renderAgentPlanCard(agent, planData) {
            const statusIcons = {
                'generating': '‚è≥',
                'summarizing': 'üìã',
                'complete': '‚úÖ',
                'improving': 'üîÑ',
                'improved': 'üéØ'
            };

            const statusColors = {
                'generating': 'bg-yellow-500',
                'summarizing': 'bg-blue-500',
                'complete': 'bg-green-500',
                'improving': 'bg-purple-500',
                'improved': 'bg-pink-500'
            };

            return `
                <div class="bg-slate-800 bg-opacity-50 rounded-xl p-5 mb-4 border border-slate-700 slide-up">
                    <!-- Agent Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full ${statusColors[planData.status]} bg-opacity-20 flex items-center justify-center">
                                <span class="text-2xl">${statusIcons[planData.status]}</span>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-purple-300">${agent.toUpperCase()}</h4>
                                <p class="text-xs text-slate-400">${planData.status}</p>
                            </div>
                        </div>
                        ${planData.score ? `
                            <div class="px-4 py-2 bg-green-500 bg-opacity-20 rounded-lg border border-green-500 border-opacity-30">
                                <div class="text-2xl font-bold text-green-400">${planData.score}</div>
                                <div class="text-xs text-slate-400">score</div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Analytics Bar -->
                    ${planData.totalDuration || planData.mini_plans.length > 0 ? `
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div class="bg-slate-900 bg-opacity-30 rounded-lg p-3">
                                <div class="text-xs text-slate-400">Mini-plans</div>
                                <div class="text-lg font-bold text-purple-400">${planData.mini_plans.length}</div>
                            </div>
                            <div class="bg-slate-900 bg-opacity-30 rounded-lg p-3">
                                <div class="text-xs text-slate-400">Total Steps</div>
                                <div class="text-lg font-bold text-blue-400">${planData.steps.length || '-'}</div>
                            </div>
                            <div class="bg-slate-900 bg-opacity-30 rounded-lg p-3">
                                <div class="text-xs text-slate-400">Duration</div>
                                <div class="text-lg font-bold text-yellow-400">${planData.totalDuration ? planData.totalDuration + 's' : '-'}</div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Mini Plans Section -->
                    ${planData.mini_plans.length > 0 ? `
                        <div class="mb-4" id="agent-${agent}-plans">
                            <div class="flex items-center justify-between mb-3">
                                <h5 class="text-sm font-semibold text-purple-400">üìã Mini-Plans Generated</h5>
                                <span class="text-xs text-slate-500">${planData.mini_plans.length} groups</span>
                            </div>
                            <div class="space-y-3 max-h-96 overflow-y-auto scroll-smooth pr-2">
                                ${planData.mini_plans.map((mp, idx) => `
                                    <div class="mini-plan-card bg-slate-900 bg-opacity-40 rounded-lg p-4 border border-slate-700">
                                        <div class="flex items-center justify-between mb-3">
                                            <div class="flex items-center gap-2">
                                                <span class="w-6 h-6 rounded-full bg-purple-500 bg-opacity-20 flex items-center justify-center text-xs font-bold text-purple-400">
                                                    ${mp.group}
                                                </span>
                                                <span class="text-sm font-semibold text-slate-300">Group ${mp.group}</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs text-green-400">‚è±Ô∏è ${mp.duration}s</span>
                                                <span class="text-xs text-slate-500">${mp.steps.length} steps</span>
                                            </div>
                                        </div>

                                        <div class="space-y-2">
                                            ${mp.steps.map((step, stepIdx) => `
                                                <div class="step-item flex items-start gap-2 text-sm text-slate-200 bg-slate-800 bg-opacity-30 p-2 rounded">
                                                    <span class="text-purple-400 font-bold flex-shrink-0 mt-0.5">${stepIdx + 1}.</span>
                                                    <span class="leading-relaxed">${step}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Final Plan -->
                    ${planData.final_plan && planData.steps.length > 0 ? `
                        <div class="bg-gradient-to-br from-slate-900 to-purple-900 bg-opacity-50 rounded-lg p-4 border border-purple-500 border-opacity-30">
                            <div class="flex items-center justify-between mb-3">
                                <h5 class="text-sm font-semibold text-purple-400">
                                    ${planData.status === 'complete' ? 'üìã Final Plan' : 'üîÑ Current Plan'}
                                </h5>
                                <span class="text-xs text-slate-400">${planData.steps.length} steps</span>
                            </div>
                            <div class="space-y-2 max-h-64 overflow-y-auto">
                                ${planData.steps.map((step, idx) => `
                                    <div class="flex items-start gap-2 text-sm text-slate-100">
                                        <span class="text-purple-400 font-bold flex-shrink-0 mt-0.5">${idx + 1}.</span>
                                        <span class="leading-relaxed">${step}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function updateProcessingDisplay() {
            updateProgressBars();
            updateLivePlansDisplay();
            updateFeaturePanel();
        }

        function renderProcessingPhase() {
            return `
                <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
                    <!-- Left: Progress & Analytics -->
                    <div class="xl:col-span-1 space-y-6">
                        <!-- Status Card -->
                        <div class="bg-slate-800 bg-opacity-50 backdrop-blur-lg rounded-2xl p-6 border border-slate-700">
                            <div class="text-center mb-4">
                                <div class="text-5xl mb-3 pulse-animate">üß†</div>
                                <h2 class="text-2xl font-bold mb-1">Processing...</h2>
                                <p class="text-slate-300 text-sm">Real-time AI Generation</p>
                                ${state.currentPhase ? `
                                    <div class="mt-3 px-4 py-2 bg-purple-500 bg-opacity-20 rounded-lg inline-block">
                                        <span class="text-purple-400 font-semibold">Phase ${state.currentPhase}</span>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- Progress Bars -->
                            <div id="agentProgressContainer" class="space-y-2">
                                <!-- Dynamically updated -->
                            </div>
                        </div>

                        <!-- üÜï FEATURE PANEL -->
                        <div class="feature-panel bg-gradient-to-br from-pink-900 via-purple-900 to-slate-900 bg-opacity-50 backdrop-blur-lg rounded-2xl p-6 border border-pink-500 border-opacity-30">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-2">
                                    <span class="text-3xl">‚ú®</span>
                                    <div>
                                        <h3 class="text-lg font-bold text-pink-300">Features Detected</h3>
                                        <p class="text-xs text-slate-400">Real-time discovery</p>
                                    </div>
                                </div>
                                <div class="relative">
                                    <div class="text-4xl font-bold text-pink-400" id="featureCounter">${state.featureCount}</div>
                                    <div class="absolute -top-2 -right-2 text-green-400 font-bold text-lg opacity-0 transition-opacity" 
                                         id="featureAdded" style="transition: opacity 0.3s;">+0</div>
                                </div>
                            </div>

                            <div id="featureList" class="max-h-96 overflow-y-auto scroll-smooth space-y-2">
                                ${state.discoveredFeatures.map((feature, index) => `
                                    <div class="feature-badge bg-gradient-to-r from-purple-500 to-pink-500 bg-opacity-10 border border-purple-500 border-opacity-30 rounded-lg px-4 py-3"
                                         style="animation-delay: ${index * 0.05}s">
                                        <div class="flex items-center gap-2">
                                            <span class="text-purple-400 font-bold text-lg">‚Ä¢</span>
                                            <span class="text-slate-100 font-medium">${feature}</span>
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-slate-400 text-sm text-center py-4">Waiting for features...</p>'}
                            </div>
                        </div>

                        <!-- Activity Log -->
                        <div class="bg-slate-800 bg-opacity-50 backdrop-blur-lg rounded-2xl p-6 border border-slate-700">
                            <h3 class="text-sm font-semibold text-slate-400 uppercase mb-3 flex items-center gap-2">
                                <span class="w-2 h-2 bg-red-500 rounded-full pulse-animate"></span>
                                Live Activity Log
                            </h3>
                            <div id="realtimeLog" class="h-96 overflow-y-auto space-y-1 bg-slate-900 bg-opacity-30 rounded-lg p-3 scroll-smooth">
                                <!-- Log entries appear here -->
                            </div>
                        </div>
                    </div>

                    <!-- Right: Live Plans (3 columns) -->
                    <div class="xl:col-span-3">
                        <div class="bg-slate-800 bg-opacity-50 backdrop-blur-lg rounded-2xl p-6 border border-slate-700">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold text-purple-300 flex items-center gap-2">
                                    <span class="text-2xl">üìù</span>
                                    Live Plans Generation
                                </h3>
                                <div class="text-xs text-slate-400">
                                    ${Object.keys(state.liveAgentPlans).length} agents active
                                </div>
                            </div>
                            <div id="livePlansContainer" class="overflow-y-auto max-h-[1000px] space-y-4 scroll-smooth">
                                <!-- Live plans appear here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Auth & Main App Functions
        async function handleLogin(e) {
            e.preventDefault();
            setState({ isLoading: true });

            try {
                const response = await fetch('http://localhost:5000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: state.username,
                        password: state.password
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    setState({
                        currentUser: data.username,
                        isAuthenticated: true,
                        password: '',
                        isLoading: false
                    });
                } else {
                    alert(data.message || 'Invalid credentials');
                    setState({ isLoading: false });
                }
            } catch (error) {
                alert('Unable to connect to server');
                setState({ isLoading: false });
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            setState({ isLoading: true });

            try {
                const response = await fetch('http://localhost:5000/api/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: state.username,
                        email: state.email,
                        password: state.password
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert('Account created! Please login.');
                    setState({
                        showLogin: true,
                        username: '',
                        password: '',
                        email: '',
                        isLoading: false
                    });
                } else {
                    alert(data.message || 'Signup failed');
                    setState({ isLoading: false });
                }
            } catch (error) {
                alert('Unable to connect to server');
                setState({ isLoading: false });
            }
        }

        function handleLogout() {
            setState({
                isAuthenticated: false,
                currentUser: null,
                username: '',
                password: '',
                email: '',
                phase: 'input',
                aim: '',
                steps: { step1: '', step2: '' },
                apiResponse: null,
                liveAgentPlans: {},
                analyticsData: {},
                discoveredFeatures: [],
                featureCount: 0
            });
        }

        function addStep() {
            const stepKeys = Object.keys(state.steps);
            const nextStepNum = stepKeys.length + 1;
            state.steps['step' + nextStepNum] = '';
            render();
        }

        function removeStep(key) {
            const newSteps = { ...state.steps };
            delete newSteps[key];

            const stepValues = Object.values(newSteps);
            const renumberedSteps = {};
            stepValues.forEach((value, index) => {
                renumberedSteps['step' + (index + 1)] = value;
            });

            state.steps = Object.keys(renumberedSteps).length > 0 ? renumberedSteps : { step1: '' };
            render();
        }

        function getWinner() {
            if (!state.apiResponse) return null;

            const agents = Object.keys(state.apiResponse).filter(key => key.startsWith('agent'));
            let winner = null;
            let maxAvg = -1;

            agents.forEach(agentKey => {
                const agent = state.apiResponse[agentKey];
                const avg = agent.average_score || 0;

                if (avg > maxAvg) {
                    maxAvg = avg;
                    winner = { ...agent, agentKey, avgScore: avg };
                }
            });

            return winner;
        }

        function reset() {
            setState({
                phase: 'input',
                aim: '',
                steps: { step1: '', step2: '' },
                apiResponse: null,
                liveAgentPlans: {},
                analyticsData: {},
                discoveredFeatures: [],
                featureCount: 0
            });
        }

        function render() {
            const app = document.getElementById('app');
            
            if (!state.isAuthenticated) {
                app.innerHTML = renderAuthScreen();
            } else {
                app.innerHTML = renderMainApp();
            }
            
            attachEventListeners();
        }

        function renderAuthScreen() {
            return `
                <div class="min-h-screen flex items-center justify-center p-8 text-white">
                    <div class="w-full max-w-md">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-purple-500 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl">üß†</div>
                            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-2">AI Planner</h1>
                            <p class="text-slate-400">Feature Detection System</p>
                        </div>

                        <div class="bg-slate-800 bg-opacity-50 backdrop-blur-lg rounded-2xl p-8 border border-slate-700 shadow-2xl">
                            <div class="flex gap-2 mb-6">
                                <button onclick="setState({ showLogin: true })" class="flex-1 py-2 rounded-lg font-semibold transition-all ${state.showLogin ? 'bg-purple-600 text-white' : 'bg-slate-700 bg-opacity-50 text-slate-400'}">
                                    Login
                                </button>
                                <button onclick="setState({ showLogin: false })" class="flex-1 py-2 rounded-lg font-semibold transition-all ${!state.showLogin ? 'bg-purple-600 text-white' : 'bg-slate-700 bg-opacity-50 text-slate-400'}">
                                    Sign Up
                                </button>
                            </div>

                            <form id="authForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-slate-300">Username</label>
                                    <input type="text" id="username" value="${state.username}" required class="w-full px-4 py-3 bg-slate-900 bg-opacity-50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter username" />
                                </div>

                                ${!state.showLogin ? `
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-slate-300">Email</label>
                                    <input type="email" id="email" value="${state.email}" required class="w-full px-4 py-3 bg-slate-900 bg-opacity-50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter email" />
                                </div>
                                ` : ''}

                                <div>
                                    <label class="block text-sm font-medium mb-2 text-slate-300">Password</label>
                                    <input type="password" id="password" value="${state.password}" required class="w-full px-4 py-3 bg-slate-900 bg-opacity-50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter password" />
                                </div>

                                <button type="submit" ${state.isLoading ? 'disabled' : ''} class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 disabled:from-slate-600 disabled:to-slate-600 rounded-xl font-semibold transition-all shadow-lg">
                                    ${state.isLoading ? 'Processing...' : state.showLogin ? 'Login' : 'Sign Up'}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainApp() {
            return `
                <div class="p-8">
                    <div class="max-w-7xl mx-auto text-white">
                        <div class="flex items-center justify-between mb-8 flex-wrap gap-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center text-2xl">üß†</div>
                                <div>
                                    <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">AI Collaborative Planner</h1>
                                    <p class="text-slate-400 text-sm">Feature Detection + Real-time Generation</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2 px-4 py-2 bg-slate-800 bg-opacity-50 rounded-lg border border-slate-700">
                                    <span class="text-2xl">üë§</span>
                                    <span class="text-slate-300">${state.currentUser}</span>
                                </div>
                                <button onclick="handleLogout()" class="flex items-center gap-2 px-4 py-2 bg-red-500 bg-opacity-20 hover:bg-opacity-30 rounded-lg transition-colors text-red-400">
                                    <span>Logout</span>
                                </button>
                            </div>
                        </div>

                        ${state.phase === 'input' ? renderInputPhase() : ''}
                        ${state.phase === 'processing' ? renderProcessingPhase() : ''}
                        ${state.phase === 'results' ? renderResultsPhase() : ''}
                    </div>
                </div>
            `;
        }

        function renderInputPhase() {
            const isAimValid = state.aim.trim().length > 0;
            const areStepsValid = Object.values(state.steps).every(s => s.trim().length > 0);
            const isFormValid = isAimValid && areStepsValid;
            
            return `
                <div class="bg-slate-800 bg-opacity-50 backdrop-blur-lg rounded-2xl p-8 border border-slate-700 shadow-2xl">
                    <div class="mb-8">
                        <label class="flex items-center gap-2 text-xl font-semibold mb-3">
                            <span class="text-2xl">üéØ</span>
                            Your Goal
                        </label>
                        <input type="text" id="aim" value="${state.aim}" placeholder="Enter your main objective..." class="w-full px-6 py-4 bg-slate-900 bg-opacity-50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg" />
                    </div>

                    <div class="mb-8">
                        <label class="flex items-center gap-2 text-xl font-semibold mb-3">
                            <span class="text-2xl">‚û°Ô∏è</span>
                            Initial Steps
                        </label>
                        <div id="stepsContainer">
                            ${Object.entries(state.steps).map(([key, value], index) => `
                                <div class="flex gap-3 mb-3">
                                    <input type="text" data-step-key="${key}" value="${value}" placeholder="Step ${index + 1}..." class="flex-1 px-6 py-3 bg-slate-900 bg-opacity-50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    ${Object.keys(state.steps).length > 1 ? `
                                        <button onclick="removeStep('${key}')" class="px-4 py-3 bg-red-500 bg-opacity-20 hover:bg-opacity-30 rounded-xl transition-colors text-red-400 font-bold">
                                            ‚úï
                                        </button>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="addStep()" class="flex items-center gap-2 px-6 py-3 bg-purple-500 bg-opacity-20 hover:bg-opacity-30 rounded-xl transition-colors text-purple-300">
                            <span class="text-xl">‚ûï</span>
                            Add Step
                        </button>
                    </div>

                    <button id="planButton" onclick="startPlanning()" ${!isFormValid || state.isLoading ? 'disabled' : ''} class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 disabled:from-slate-600 disabled:to-slate-600 disabled:cursor-not-allowed rounded-xl font-semibold text-lg transition-all shadow-lg">
                        ${state.isLoading ? 'Processing...' : '‚ú® Start AI Planning'}
                    </button>
                    <p id="errorMsg" style="display: ${isFormValid ? 'none' : 'block'}" class="text-sm text-red-400 mt-2 text-center">Please fill all fields to continue</p>
                </div>
            `;
        }

        function renderResultsPhase() {
            const winner = getWinner();
            const agents = Object.keys(state.apiResponse || {}).filter(key => key.startsWith('agent'));

            return `
                <div class="space-y-6">
                    ${winner ? `
                        <div class="bg-gradient-to-r from-yellow-500 from-opacity-20 to-orange-500 to-opacity-20 backdrop-blur-lg rounded-2xl p-8 border border-yellow-500 border-opacity-30 shadow-2xl">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">üèÜ</div>
                                <h2 class="text-4xl font-bold mb-2">Winner: ${winner.agent_name ? winner.agent_name.toUpperCase() : 'AI Agent ' + winner.agentKey.replace('agent', '')}</h2>
                                <p class="text-3xl text-yellow-400 font-bold mb-4">Average Score: ${winner.avgScore.toFixed(1)}</p>
                                <p class="text-slate-400">Original: ${winner.original_score} ‚Üí Final: ${winner.final_score} (${winner.total_improvements} improvements)</p>
                            </div>

                            <div class="bg-slate-900 bg-opacity-50 rounded-xl p-6 mt-6">
                                <h3 class="text-xl font-semibold mb-4 text-yellow-400">Winning Plan Steps:</h3>
                                <div class="space-y-3">
                                    ${Object.entries(winner.steps || {}).map(([key, step], idx) => `
                                        <div class="flex items-start gap-3">
                                            <div class="w-8 h-8 rounded-full bg-yellow-500 bg-opacity-20 flex items-center justify-center flex-shrink-0">
                                                <span class="text-yellow-400 font-bold">${idx + 1}</span>
                                            </div>
                                            <span class="text-slate-200 text-lg">${step}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- üÜï FEATURES DISCOVERED SECTION -->
                    ${state.discoveredFeatures.length > 0 ? `
                        <div class="bg-gradient-to-br from-pink-900 via-purple-900 to-slate-900 bg-opacity-50 backdrop-blur-lg rounded-2xl p-8 border border-pink-500 border-opacity-30">
                            <div class="flex items-center gap-3 mb-6">
                                <span class="text-5xl">‚ú®</span>
                                <div>
                                    <h2 class="text-3xl font-bold text-pink-300">Features Discovered</h2>
                                    <p class="text-slate-400">Total: ${state.featureCount} features identified</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                ${state.discoveredFeatures.map((feature, index) => `
                                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 bg-opacity-10 border border-purple-500 border-opacity-30 rounded-lg px-4 py-3">
                                        <div class="flex items-center gap-2">
                                            <span class="text-purple-400 font-bold text-lg">‚Ä¢</span>
                                            <span class="text-slate-100 font-medium">${feature}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        ${agents.map(agentKey => {
                            const agentData = state.apiResponse[agentKey];
                            const avgScore = agentData.average_score || 0;
                            const isWinner = winner && winner.agentKey === agentKey;
                            
                            return `
                                <div class="bg-slate-800 bg-opacity-50 backdrop-blur-lg rounded-xl p-6 border ${isWinner ? 'border-yellow-500 ring-2 ring-yellow-500 ring-opacity-50' : 'border-slate-700'}">
                                    <div class="flex items-center justify-between mb-4">
                                        <div>
                                            <h3 class="font-semibold text-lg">${agentData.agent_name ? agentData.agent_name.toUpperCase() : 'Agent ' + agentKey.replace('agent', '')}</h3>
                                            <p class="text-sm text-slate-400">AI Agent ${agentKey.replace('agent', '')}</p>
                                        </div>
                                        ${isWinner ? '<span class="text-2xl">üèÜ</span>' : ''}
                                    </div>
                                    
                                    <div class="mb-4">
                                        <div class="text-3xl font-bold mb-2">
                                            <span class="text-purple-400">${avgScore.toFixed(1)}</span>
                                            <span class="text-sm text-slate-400 ml-2">avg score</span>
                                        </div>
                                        <div class="text-sm text-slate-400">
                                            Original: ${agentData.original_score} ‚Üí Final: ${agentData.final_score}
                                            <span class="text-green-400 ml-2">+${agentData.final_score - agentData.original_score}</span>
                                        </div>
                                    </div>

                                    <div class="mb-4">
                                        <h4 class="text-xs font-semibold text-slate-500 uppercase mb-2">Action Plan (${Object.keys(agentData.steps || {}).length} steps):</h4>
                                        <div class="space-y-2 max-h-60 overflow-y-auto">
                                            ${Object.entries(agentData.steps || {}).map(([key, step], idx) => `
                                                <div class="text-sm text-slate-300 flex items-start gap-2 bg-slate-900 bg-opacity-30 p-2 rounded">
                                                    <span class="text-purple-400 font-bold flex-shrink-0">${idx + 1}.</span>
                                                    <span>${step}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <div class="space-y-2">
                                        <h4 class="text-xs font-semibold text-slate-500 uppercase">Score Progress:</h4>
                                        <div class="flex flex-wrap gap-2">
                                            ${(agentData.all_improvement_scores || []).map((score, idx) => `
                                                <div class="px-3 py-1 bg-slate-900 bg-opacity-50 rounded-lg text-sm">
                                                    <span class="text-slate-400">${idx === 0 ? 'Orig' : `R${idx}`}:</span>
                                                    <span class="ml-2 font-bold text-purple-400">${score}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <button onclick="reset()" class="w-full py-4 bg-slate-700 hover:bg-slate-600 rounded-xl font-semibold text-lg transition-all">
                        ‚ö° Start New Plan
                    </button>
                </div>
            `;
        }

        function attachEventListeners() {
            const authForm = document.getElementById('authForm');
            if (authForm) {
                authForm.onsubmit = state.showLogin ? handleLogin : handleSignup;
            }

            const usernameInput = document.getElementById('username');
            if (usernameInput) {
                usernameInput.oninput = (e) => {
                    state.username = e.target.value;
                };
            }

            const emailInput = document.getElementById('email');
            if (emailInput) {
                emailInput.oninput = (e) => {
                    state.email = e.target.value;
                };
            }

            const passwordInput = document.getElementById('password');
            if (passwordInput) {
                passwordInput.oninput = (e) => {
                    state.password = e.target.value;
                };
            }

            const aimInput = document.getElementById('aim');
            if (aimInput) {
                aimInput.oninput = (e) => {
                    state.aim = e.target.value;
                    updateButtonState();
                };
            }

            const stepInputs = document.querySelectorAll('[data-step-key]');
            stepInputs.forEach(input => {
                input.oninput = (e) => {
                    const key = e.target.getAttribute('data-step-key');
                    state.steps[key] = e.target.value;
                    updateButtonState();
                };
            });
        }

        function updateButtonState() {
            const button = document.querySelector('#planButton');
            const errorMsg = document.querySelector('#errorMsg');
            
            if (button && errorMsg) {
                const isAimValid = state.aim.trim().length > 0;
                const areStepsValid = Object.values(state.steps).every(s => s.trim().length > 0);
                const isFormValid = isAimValid && areStepsValid;
                
                button.disabled = !isFormValid || state.isLoading;
                errorMsg.style.display = isFormValid ? 'none' : 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', render);
        render();
    </script>
</body>
</html>
