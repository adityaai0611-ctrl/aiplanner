<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Planner - Feature Detection + Fraud Detection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ... KEEP ALL EXISTING STYLES ... */
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes popIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes countUp {
            0% {
                transform: translateY(10px) scale(1.5);
                opacity: 0;
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .slide-up {
            animation: slideUp 0.5s ease-out;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        .pulse-animate {
            animation: pulse 2s infinite;
        }

        .pop-in {
            animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .count-up {
            animation: countUp 0.4s ease-out;
        }

        .feature-badge {
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .scroll-smooth {
            scroll-behavior: smooth;
        }

        .mini-plan-card {
            transition: all 0.3s ease;
        }

        .mini-plan-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -5px rgba(139, 92, 246, 0.2);
        }

        .step-item {
            animation: slideUp 0.4s ease-out;
            animation-fill-mode: both;
        }

        .feature-panel {
            position: sticky;
            top: 20px;
        }
        
        /* NEW: Fraud alert animation */
        @keyframes alertPulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% { 
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }
        
        .fraud-alert {
            animation: alertPulse 2s infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen">
    <div id="app" class="min-h-screen"></div>

    <script>
        // UPDATED STATE WITH FRAUD DETECTION AND TOOL MANAGEMENT
        let state = {
            isAuthenticated: false,
            showLogin: true,
            username: '',
            password: '',
            email: '',
            currentUser: null,
            aim: '',
            steps: { step1: '', step2: '' },
            phase: 'input',
            apiResponse: null,
            isLoading: false,
            realtimeEvents: [],
            currentPhase: null,
            agentProgress: {},
            liveAgentPlans: {},
            analyticsData: {},
            eventSource: null,
            discoveredFeatures: [],
            featureCount: 0,
            newFeatureAnimation: null,
            naturalLanguageInput: '',
            showConfirmation: false,
            // NEW: Add fraud and tech tracking
            fraudDetections: [],
            fraudAlertCount: 0,
            techSuggestions: [],
            safetyNodes: [],
            // NEW: Add tool management to state
            toolName: '',
            isToolProcessing: false,
            activeTool: null,  // Stores {name, toolPath, paramPath}
            showToolInput: false
        };

        function setState(updates) {
            const needsFullRender = 
                updates.hasOwnProperty('isAuthenticated') ||
                updates.hasOwnProperty('showLogin') ||
                updates.hasOwnProperty('phase') ||
                updates.hasOwnProperty('showConfirmation');
            
            state = { ...state, ...updates };
            
            if (needsFullRender) {
                render();
            }
        }

        async function parseNaturalLanguage() {
            const input = document.getElementById('naturalLanguageInput').value.trim();
            const parseButton = document.getElementById('parseButton');
            const parseButtonText = document.getElementById('parseButtonText');
            
            if (!input) {
                alert('Please enter some text to convert');
                return;
            }
            
            if (input.length < 10) {
                alert('Please provide more details (at least 10 characters)');
                return;
            }
            
            setState({ isLoading: true });
            if (parseButtonText) parseButtonText.textContent = 'Converting...';
            if (parseButton) parseButton.disabled = true;
            
            try {
                const response = await fetch('http://localhost:5000/api/parse-natural-language', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input: input })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    setState({
                        aim: data.aim,
                        steps: data.steps,
                        naturalLanguageInput: input,
                        showConfirmation: true,
                        isLoading: false
                    });
                } else {
                    alert('‚ùå ' + (data.message || 'Failed to parse input'));
                    setState({ isLoading: false });
                }
                
            } catch (error) {
                console.error('Parse error:', error);
                alert('‚ùå Unable to connect to server');
                setState({ isLoading: false });
            } finally {
                if (parseButtonText) parseButtonText.textContent = 'Convert to AIM + Steps';
                if (parseButton) parseButton.disabled = false;
            }
        }

        function confirmAndStartPlanning() {
            setState({ 
                showConfirmation: false,
                naturalLanguageInput: ''
            });
            startPlanning();
        }

        function goBackToEdit() {
            setState({ 
                showConfirmation: false
            });
            
            setTimeout(() => {
                const nlInput = document.getElementById('naturalLanguageInput');
                if (nlInput) {
                    nlInput.value = state.naturalLanguageInput;
                    nlInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    nlInput.focus();
                }
            }, 100);
        }

        function renderConfirmationScreen() {
            return `
                <div class="space-y-6 max-w-5xl mx-auto">
                    ${state.activeTool ? `
                        <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-xl p-4 border-2 border-blue-400 border-opacity-50 shadow-lg slide-up">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-blue-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                                        <span class="text-2xl">üîß</span>
                                    </div>
                                    <div>
                                        <div class="text-xs text-blue-300 font-semibold uppercase">Active Tool</div>
                                        <div class="text-blue-200 font-bold text-xl">${state.activeTool.name}</div>
                                        <div class="text-blue-400 text-xs mt-0.5">Will be used during planning</div>
                                    </div>
                                </div>
                                <button 
                                    onclick="removeTool()"
                                    class="group w-10 h-10 bg-red-500 bg-opacity-10 hover:bg-opacity-30 rounded-lg flex items-center justify-center transition-all border border-red-500 border-opacity-30 hover:border-opacity-60"
                                    title="Remove tool"
                                >
                                    <span class="text-red-400 group-hover:text-red-300 text-xl font-bold">‚úï</span>
                                </button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="text-center">
                        <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-blue-500 rounded-full mx-auto mb-4 flex items-center justify-center text-5xl animate-bounce">
                            ‚úÖ
                        </div>
                        <h2 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-400 mb-2">
                            AI Interpretation Complete
                        </h2>
                        <p class="text-slate-400 text-lg">
                            Please review and confirm the structured plan below
                        </p>
                    </div>

                    <div class="bg-slate-800 bg-opacity-50 backdrop-blur-lg rounded-xl p-6 border border-slate-700">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">üìù</span>
                            <h3 class="text-lg font-semibold text-slate-300">Your Original Input:</h3>
                        </div>
                        <div class="bg-slate-900 bg-opacity-50 rounded-lg p-4 border border-slate-600">
                            <p class="text-slate-300 italic leading-relaxed">"${state.naturalLanguageInput}"</p>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-green-900 via-blue-900 to-slate-900 bg-opacity-50 backdrop-blur-lg rounded-2xl p-8 border-2 border-green-500 border-opacity-30 shadow-2xl">
                        <div class="flex items-center gap-3 mb-6">
                            <span class="text-4xl">üéØ</span>
                            <div>
                                <h3 class="text-2xl font-bold text-green-300">AI Interpreted This As:</h3>
                                <p class="text-slate-400 text-sm">Structured into AIM and STEPS format</p>
                            </div>
                        </div>

                        <div class="mb-6">
                            <div class="flex items-center gap-2 mb-3">
                                <div class="w-8 h-8 bg-blue-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                                    <span class="text-xl">üéØ</span>
                                </div>
                                <h4 class="text-xl font-bold text-blue-300">Main Goal (AIM)</h4>
                            </div>
                            <div class="bg-slate-900 bg-opacity-50 rounded-xl p-5 border-l-4 border-blue-500">
                                <p class="text-white text-lg font-medium leading-relaxed">${state.aim}</p>
                            </div>
                        </div>

                        <div>
                            <div class="flex items-center gap-2 mb-3">
                                <div class="w-8 h-8 bg-purple-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                                    <span class="text-xl">‚û°Ô∏è</span>
                                </div>
                                <h4 class="text-xl font-bold text-purple-300">Action Steps (${Object.keys(state.steps).length} steps)</h4>
                            </div>
                            <div class="space-y-3">
                                ${Object.entries(state.steps).map(([key, step], index) => `
                                    <div class="flex items-start gap-3 bg-slate-900 bg-opacity-50 rounded-xl p-4 border-l-4 border-purple-500 slide-up" style="animation-delay: ${index * 0.05}s">
                                        <div class="w-8 h-8 bg-purple-500 bg-opacity-20 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <span class="text-purple-300 font-bold">${index + 1}</span>
                                        </div>
                                        <p class="text-slate-200 text-base leading-relaxed pt-1">${step}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button 
                            onclick="goBackToEdit()"
                            class="flex-1 flex items-center justify-center gap-3 py-4 bg-slate-700 hover:bg-slate-600 rounded-xl font-semibold text-lg transition-all border-2 border-slate-600 hover:border-slate-500"
                        >
                            <span class="text-2xl">‚¨ÖÔ∏è</span>
                            <span>Go Back & Edit</span>
                        </button>
                        
                        <button 
                            onclick="confirmAndStartPlanning()"
                            class="flex-1 flex items-center justify-center gap-3 py-4 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 rounded-xl font-semibold text-lg transition-all shadow-lg border-2 border-green-500 border-opacity-30"
                        >
                            <span class="text-2xl">üöÄ</span>
                            <span>Looks Good! Start Planning</span>
                        </button>
                    </div>

                    <div class="bg-blue-500 bg-opacity-10 border border-blue-500 border-opacity-30 rounded-xl p-4">
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">üí°</span>
                            <div>
                                <p class="text-blue-300 font-semibold mb-1">What happens next?</p>
                                <p class="text-slate-400 text-sm">
                                    If you click "Start Planning", our 12 AI agents will analyze and improve this plan from different perspectives, 
                                    discovering new features and optimizations in real-time.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function startPlanning() {
            setState({ 
                isLoading: true, 
                phase: 'processing',
                realtimeEvents: [],
                agentProgress: {},
                liveAgentPlans: {},
                analyticsData: {},
                discoveredFeatures: [],
                featureCount: 0,
                fraudDetections: [],
                fraudAlertCount: 0,
                techSuggestions: [],
                safetyNodes: []
            });

            try {
                const response = await fetch('http://localhost:5000/api/plan/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: state.currentUser,
                        aim: state.aim,
                        steps: state.steps
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const eventData = JSON.parse(line.substring(6));
                            handleRealtimeEvent(eventData);
                        }
                    }
                }

            } catch (error) {
                console.error('Streaming error:', error);
                alert('Planning failed: ' + error.message);
                setState({ phase: 'input', isLoading: false });
            }
        }

        function parseStepsFromPlan(planText) {
            if (!planText) return [];
            
            const steps = [];
            const lines = planText.split('\n');
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed && (
                    trimmed.startsWith('-') || 
                    trimmed.startsWith('‚Ä¢') || 
                    /^\d+\./.test(trimmed) ||
                    /^step\s*\d+/i.test(trimmed)
                )) {
                    let step = trimmed
                        .replace(/^[-‚Ä¢]/, '')
                        .replace(/^\d+\./, '')
                        .replace(/^step\s*\d+:?/i, '')
                        .trim();
                    
                    if (step) {
                        steps.push(step);
                    }
                }
            }
            
            return steps;
        }

        // UPDATED handleRealtimeEvent WITH NEW CASES
        function handleRealtimeEvent(event) {
            console.log('Real-time event:', event);
            state.realtimeEvents.push(event);

            const timestamp = new Date();

            switch(event.type) {
                case 'connected':
                    addLogMessage('‚úÖ Connected to AI Planning System', 'success');
                    break;

                case 'process_start':
                    addLogMessage(`üöÄ Starting planning for ${event.data.agents_count} AI agents`, 'info');
                    state.analyticsData.processStartTime = timestamp;
                    break;

                case 'feature_detection_start':
                    addLogMessage('üîç Starting feature detection...', 'feature');
                    break;

                case 'features_discovered':
                case 'features_detected':
                    handleFeatureDetection(event.data);
                    break;

                case 'phase_start':
                    state.currentPhase = event.data.phase;
                    addLogMessage(`üìç Phase ${event.data.phase}: ${event.data.description}`, 'info');
                    updateProcessingDisplay();
                    break;

                case 'agent_start':
                    addLogMessage(`ü§ñ ${event.data.agent.toUpperCase()} - Starting plan generation`, 'agent');
                    state.liveAgentPlans[event.data.agent] = {
                        status: 'generating',
                        mini_plans: [],
                        final_plan: null,
                        steps: [],
                        score: null,
                        startTime: timestamp,
                        parameters_used: []
                    };
                    updateAgentProgress(event.data.agent, 'generating', 0);
                    updateLivePlansDisplay();
                    break;

                case 'mini_plan_start':
                    addLogMessage(`  üîç ${event.data.agent.toUpperCase()} - Processing group ${event.data.group}/${event.data.total_groups}`, 'progress');
                    
                    if (state.liveAgentPlans[event.data.agent]) {
                        const miniPlanData = {
                            group: event.data.group,
                            startTime: timestamp,
                            status: 'processing',
                            parameters: event.data.parameters || []
                        };
                        
                        if (!state.liveAgentPlans[event.data.agent].current_mini_plan) {
                            state.liveAgentPlans[event.data.agent].current_mini_plan = miniPlanData;
                        }
                    }
                    
                    updateAgentProgress(event.data.agent, 'generating', event.data.progress);
                    updateLivePlansDisplay();
                    break;

                case 'mini_plan_complete':
                    const completionTime = timestamp;
                    const agent = event.data.agent;
                    
                    addLogMessage(`  ‚úÖ ${agent.toUpperCase()} - Group ${event.data.group} completed`, 'success');
                    
                    if (state.liveAgentPlans[agent]) {
                        const miniPlan = state.liveAgentPlans[agent].current_mini_plan || {};
                        const duration = miniPlan.startTime ? 
                            ((completionTime - miniPlan.startTime) / 1000).toFixed(2) : 0;
                        
                        const completedMiniPlan = {
                            group: event.data.group,
                            preview: event.data.mini_plan,
                            steps: parseStepsFromPlan(event.data.mini_plan),
                            startTime: miniPlan.startTime || completionTime,
                            endTime: completionTime,
                            duration: duration,
                            parameters: event.data.parameters || miniPlan.parameters || [],
                            status: 'completed'
                        };
                        
                        state.liveAgentPlans[agent].mini_plans.push(completedMiniPlan);
                        state.liveAgentPlans[agent].current_mini_plan = null;
                    }
                    
                    updateAgentProgress(event.data.agent, 'generating', event.data.progress);
                    updateLivePlansDisplay();
                    scrollToLatestMiniPlan(agent);
                    break;

                case 'summarizing':
                    addLogMessage(`  üìã ${event.data.agent.toUpperCase()} - Summarizing ${event.data.mini_plans_count} mini-plans`, 'info');
                    if (state.liveAgentPlans[event.data.agent]) {
                        state.liveAgentPlans[event.data.agent].status = 'summarizing';
                    }
                    updateLivePlansDisplay();
                    break;

                case 'agent_complete':
                    addLogMessage(`  üéâ ${event.data.agent.toUpperCase()} - Plan complete! Score: ${event.data.score}/100`, 'success');
                    
                    if (state.liveAgentPlans[event.data.agent]) {
                        const agentData = state.liveAgentPlans[event.data.agent];
                        agentData.final_plan = event.data.plan;
                        agentData.steps = parseStepsFromPlan(event.data.plan);
                        agentData.score = event.data.score;
                        agentData.status = 'complete';
                        agentData.endTime = timestamp;
                        
                        const totalDuration = agentData.startTime ? 
                            ((timestamp - agentData.startTime) / 1000).toFixed(2) : 0;
                        agentData.totalDuration = totalDuration;
                    }
                    
                    updateAgentProgress(event.data.agent, 'complete', 100, event.data.score);
                    updateLivePlansDisplay();
                    break;

                case 'improvement_chain_start':
                    addLogMessage(`üîÑ Starting improvement chain for ${event.data.original_agent.toUpperCase()}`, 'info');
                    if (state.liveAgentPlans[event.data.original_agent]) {
                        state.liveAgentPlans[event.data.original_agent].status = 'improving';
                        state.liveAgentPlans[event.data.original_agent].improvements = [];
                    }
                    updateLivePlansDisplay();
                    break;

                case 'improvement_start':
                    addLogMessage(`  üîß ${event.data.improving_agent.toUpperCase()} improving ${event.data.original_agent.toUpperCase()}'s plan (${event.data.step}/${event.data.total_steps})`, 'progress');
                    break;

                case 'improvement_complete':
                    addLogMessage(`  ‚ú® ${event.data.improving_agent.toUpperCase()} improved to score: ${event.data.score}`, 'success');
                    
                    if (state.liveAgentPlans[event.data.original_agent]) {
                        const improvement = {
                            by_agent: event.data.improving_agent,
                            step: event.data.step,
                            score: event.data.score,
                            plan_preview: event.data.plan_preview,
                            steps: parseStepsFromPlan(event.data.plan_preview),
                            timestamp: timestamp
                        };
                        
                        if (!state.liveAgentPlans[event.data.original_agent].improvements) {
                            state.liveAgentPlans[event.data.original_agent].improvements = [];
                        }
                        state.liveAgentPlans[event.data.original_agent].improvements.push(improvement);
                    }
                    
                    updateAgentProgress(event.data.original_agent, 'improving', 
                        (event.data.step / 11) * 100, event.data.score);
                    updateLivePlansDisplay();
                    break;

                case 'improvement_chain_complete':
                    addLogMessage(`  üèÅ ${event.data.original_agent.toUpperCase()} - Final score: ${event.data.final_score} (avg: ${event.data.average_score.toFixed(1)})`, 'success');
                    
                    if (state.liveAgentPlans[event.data.original_agent]) {
                        state.liveAgentPlans[event.data.original_agent].final_score = event.data.final_score;
                        state.liveAgentPlans[event.data.original_agent].average_score = event.data.average_score;
                        state.liveAgentPlans[event.data.original_agent].all_scores = event.data.all_scores;
                        state.liveAgentPlans[event.data.original_agent].status = 'improved';
                    }
                    updateLivePlansDisplay();
                    break;

                // NEW CASES FOR FRAUD DETECTION AND TECH INTEGRATION
                case 'fraud_detection':
                    handleFraudDetection(event.data);
                    break;

                case 'node_generated':
                    handleNodeGeneration(event.data);
                    break;

                case 'tech_integration':
                    handleTechIntegration(event.data);
                    break;

                case 'process_complete':
                    addLogMessage(`üéä Planning complete! ${event.data.total_agents} agents finished`, 'success');
                    state.analyticsData.processEndTime = timestamp;
                    setState({ 
                        apiResponse: event.data.result,
                        phase: 'results',
                        isLoading: false
                    });
                    break;

                case 'error':
                    addLogMessage(`‚ùå Error: ${event.data.message}`, 'error');
                    setState({ phase: 'input', isLoading: false });
                    break;
            }
        }

        // NEW FRAUD DETECTION FUNCTIONS
        function handleFraudDetection(data) {
            const result = data.result;
            const agent = data.agent;
            const group = data.group;
            
            state.fraudDetections.push({
                agent: agent,
                group: group,
                ...result,
                timestamp: new Date().toISOString()
            });
            
            if (result.suspicion_score > 0.6) {
                state.fraudAlertCount++;
                addLogMessage(`‚ö†Ô∏è FRAUD ALERT - ${agent} group ${group}: ${result.risk_type} (${result.suspicion_score.toFixed(2)})`, 'error');
            } else {
                addLogMessage(`‚úÖ Fraud Check - ${agent} group ${group}: Safe`, 'success');
            }
            
            updateFraudPanel();
        }

        function handleNodeGeneration(data) {
            const node = data.node;
            const agent = data.agent;
            const group = data.group;
            
            if (!node.error && !node.skipped) {
                state.safetyNodes.push({
                    agent: agent,
                    group: group,
                    ...node,
                    timestamp: new Date().toISOString()
                });
                
                addLogMessage(`üõ°Ô∏è Safety Node Generated: ${node.node_name}`, 'info');
                updateSafetyNodesPanel();
            }
        }

        function handleTechIntegration(data) {
            const suggestions = data.suggestions;
            const agent = data.agent;
            const group = data.group;
            
            if (suggestions && !suggestions.error) {
                state.techSuggestions.push({
                    agent: agent,
                    group: group,
                    ...suggestions,
                    timestamp: new Date().toISOString()
                });
                
                const count = suggestions.suggestions?.length || 0;
                addLogMessage(`üîß Tech Integration - ${agent} group ${group}: ${count} suggestions`, 'info');
                updateTechPanel();
            }
        }

        function updateFraudPanel() {
            const fraudList = document.getElementById('fraudDetectionList');
            if (!fraudList) return;
            
            const recentFrauds = state.fraudDetections.slice(-10).reverse();
            
            if (recentFrauds.length === 0) {
                fraudList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-2">üõ°Ô∏è</div>
                        <p class="text-slate-400">No fraud checks yet</p>
                    </div>
                `;
                return;
            }
            
            fraudList.innerHTML = recentFrauds.map((fraud, idx) => {
                const isAlert = fraud.suspicion_score > 0.6;
                const borderColor = isAlert ? 'border-red-500' : 'border-green-500';
                const bgColor = isAlert ? 'from-red-900' : 'from-green-900';
                const icon = isAlert ? '‚ö†Ô∏è' : '‚úÖ';
                
                return `
                    <div class="bg-gradient-to-r ${bgColor} to-slate-900 bg-opacity-40 border ${borderColor} border-opacity-30 rounded-lg p-3 ${isAlert ? 'fraud-alert' : ''}" 
                         style="animation-delay: ${idx * 0.05}s">
                        <div class="flex items-start gap-3">
                            <div class="text-2xl">${icon}</div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-bold text-sm">${fraud.agent.toUpperCase()} - Group ${fraud.group}</span>
                                    <span class="px-2 py-0.5 bg-slate-900 bg-opacity-50 rounded text-xs ${isAlert ? 'text-red-400' : 'text-green-400'}">
                                        ${(fraud.suspicion_score * 100).toFixed(0)}%
                                    </span>
                                </div>
                                <div class="text-xs text-slate-300 mb-1">
                                    <span class="font-semibold">Type:</span> ${fraud.risk_type}
                                </div>
                                <div class="text-xs text-slate-300 mb-1">
                                    <span class="font-semibold">Action:</span> ${fraud.suggested_action}
                                </div>
                                ${fraud.reason_list && fraud.reason_list.length > 0 ? `
                                    <div class="text-xs text-slate-400 mt-2">
                                        ${fraud.reason_list.slice(0, 2).map(reason => `‚Ä¢ ${reason}`).join('<br>')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update counter
            const fraudCounter = document.getElementById('fraudAlertCounter');
            if (fraudCounter) {
                fraudCounter.textContent = state.fraudAlertCount;
            }
        }

        function updateSafetyNodesPanel() {
            const nodesList = document.getElementById('safetyNodesList');
            if (!nodesList) return;
            
            if (state.safetyNodes.length === 0) {
                nodesList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-2">üîí</div>
                        <p class="text-slate-400">No safety nodes generated yet</p>
                    </div>
                `;
                return;
            }
            
            nodesList.innerHTML = state.safetyNodes.map((node, idx) => `
                <div class="bg-gradient-to-r from-blue-900 to-slate-900 bg-opacity-40 border border-blue-500 border-opacity-30 rounded-lg p-4 slide-up"
                     style="animation-delay: ${idx * 0.05}s">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-blue-500 bg-opacity-20 rounded-lg flex items-center justify-center text-xl">üõ°Ô∏è</div>
                        <div class="flex-1">
                            <div class="font-bold text-blue-300 mb-1">${node.node_name}</div>
                            <div class="text-xs text-slate-400 mb-2">${node.agent.toUpperCase()} - Group ${node.group}</div>
                            <div class="text-sm text-slate-300 mb-2">${node.node_purpose}</div>
                            ${node.integration_steps ? `
                                <div class="text-xs text-slate-400">
                                    <span class="font-semibold">Integration:</span> After ${node.integration_steps.attach_after_step}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateTechPanel() {
            const techList = document.getElementById('techSuggestionsList');
            if (!techList) return;
            
            if (state.techSuggestions.length === 0) {
                techList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-2">üîß</div>
                        <p class="text-slate-400">No tech suggestions yet</p>
                    </div>
                `;
                return;
            }
            
            const allSuggestions = state.techSuggestions.flatMap(tech => 
                (tech.suggestions || []).map(s => ({
                    ...s,
                    agent: tech.agent,
                    group: tech.group
                }))
            );
            
            techList.innerHTML = allSuggestions.slice(-15).map((suggestion, idx) => {
                const levelColor = {
                    'Auto': 'green',
                    'Semi': 'yellow',
                    'Manual': 'red'
                }[suggestion.automation_level] || 'blue';
                
                return `
                    <div class="bg-gradient-to-r from-purple-900 to-slate-900 bg-opacity-40 border border-purple-500 border-opacity-30 rounded-lg p-3 slide-up"
                         style="animation-delay: ${idx * 0.03}s">
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 bg-purple-500 bg-opacity-20 rounded-lg flex items-center justify-center text-purple-400 font-bold flex-shrink-0">
                                ${suggestion.step_number}
                            </div>
                            <div class="flex-1">
                                <div class="text-xs text-slate-500 mb-1">${suggestion.agent?.toUpperCase()} - Group ${suggestion.group}</div>
                                <div class="text-sm text-slate-300 mb-2">${suggestion.original_step}</div>
                                <div class="flex flex-wrap gap-1 mb-2">
                                    ${(suggestion.tools || []).map(tool => `
                                        <span class="px-2 py-0.5 bg-purple-500 bg-opacity-20 rounded text-xs text-purple-300 border border-purple-500 border-opacity-30">
                                            ${tool}
                                        </span>
                                    `).join('')}
                                </div>
                                <div class="text-xs text-slate-400 mb-1">${suggestion.use_case}</div>
                                <div class="flex items-center gap-2">
                                    <span class="px-2 py-0.5 bg-${levelColor}-500 bg-opacity-20 rounded text-xs text-${levelColor}-400 border border-${levelColor}-500 border-opacity-30">
                                        ${suggestion.automation_level}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function handleFeatureDetection(data) {
            const features = data.features || [];
            const source = data.source || 'unknown';
            const totalFeatures = data.total_features || 0;
            
            if (features.length > 0) {
                features.forEach(feature => {
                    state.discoveredFeatures.push({
                        feature: feature,
                        source: source,
                        timestamp: new Date().toISOString()
                    });
                });
                
                state.featureCount = totalFeatures;
                
                addLogMessage(`‚ú® +${features.length} new features from ${source}`, 'feature');
                
                animateFeatureCounter(features.length);
                
                updateFeaturePanel();
                updateFeatureStats();
            }
        }

        function updateFeatureStats() {
            const aimFeatures = state.discoveredFeatures.filter(f => 
                f.source && f.source.includes('aim')).length;
            const aiFeatures = state.discoveredFeatures.filter(f => 
                f.source && (f.source.includes('mini_plan') || f.source.includes('group'))).length;
            const recentFeatures = state.discoveredFeatures.filter(f => {
                const featureTime = new Date(f.timestamp);
                const now = new Date();
                return (now - featureTime) < 30000;
            }).length;

            const fromAimEl = document.getElementById('fromAimCount');
            const fromAIEl = document.getElementById('fromAICount');
            const recentEl = document.getElementById('recentCount');
            const mainCountEl = document.getElementById('featureCountMain');

            if (fromAimEl) fromAimEl.textContent = aimFeatures;
            if (fromAIEl) fromAIEl.textContent = aiFeatures;
            if (recentEl) recentEl.textContent = recentFeatures;
            if (mainCountEl) mainCountEl.textContent = state.featureCount;
        }

        function animateFeatureCounter(newCount) {
            const counterEl = document.getElementById('featureCounter');
            const addedEl = document.getElementById('featureAdded');
            
            if (counterEl && addedEl) {
                addedEl.textContent = `+${newCount}`;
                addedEl.classList.remove('count-up');
                void addedEl.offsetWidth;
                addedEl.classList.add('count-up');
                addedEl.style.opacity = '1';
                
                counterEl.textContent = state.featureCount;
                
                setTimeout(() => {
                    addedEl.style.opacity = '0';
                }, 2000);
            }
        }

        function updateFeaturePanel() {
            const featureList = document.getElementById('featureList');
            if (!featureList) return;
            
            if (state.discoveredFeatures.length === 0) {
                featureList.innerHTML = `
                    <div class="col-span-2 text-center py-20">
                        <div class="text-6xl mb-4 pulse-animate">üîç</div>
                        <p class="text-slate-400 text-lg">Waiting for AI to discover features...</p>
                        <p class="text-slate-500 text-sm mt-2">Features will appear here in real-time</p>
                    </div>
                `;
                return;
            }
            
            featureList.innerHTML = state.discoveredFeatures.map((featureObj, index) => {
                const feature = featureObj.feature || featureObj;
                const source = featureObj.source || 'unknown';
                const sourceIcon = source.includes('aim') ? 'üìç' : 
                                 source.includes('mini_plan') ? 'ü§ñ' : 
                                 source.includes('improvement') ? '‚ö°' : '‚ú®';
                const sourceColor = source.includes('aim') ? 'purple' : 
                                  source.includes('mini_plan') ? 'blue' : 
                                  source.includes('improvement') ? 'green' : 'pink';
                
                return `
                    <div class="feature-badge bg-gradient-to-br from-slate-900 to-${sourceColor}-900 bg-opacity-50 backdrop-blur-sm border-2 border-${sourceColor}-500 border-opacity-30 rounded-xl p-4 hover:border-opacity-60 transition-all duration-300 hover:scale-105"
                         style="animation-delay: ${index * 0.03}s">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-${sourceColor}-500 bg-opacity-20 rounded-lg flex items-center justify-center flex-shrink-0 text-2xl">
                                ${sourceIcon}
                            </div>
                            <div class="flex-1">
                                <div class="text-slate-100 font-medium text-sm leading-relaxed mb-2">
                                    ${typeof feature === 'string' ? feature : feature.text || 'Unknown feature'}
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs px-2 py-0.5 bg-${sourceColor}-500 bg-opacity-20 rounded text-${sourceColor}-400 border border-${sourceColor}-500 border-opacity-30">
                                        ${source}
                                    </span>
                                    <span class="text-xs text-slate-500">#${index + 1}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateFeatureStats();
        }

        function scrollToLatestMiniPlan(agent) {
            setTimeout(() => {
                const container = document.getElementById(`agent-${agent}-plans`);
                if (container) {
                    const cards = container.querySelectorAll('.mini-plan-card');
                    if (cards.length > 0) {
                        cards[cards.length - 1].scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'nearest' 
                        });
                    }
                }
            }, 100);
        }

        function addLogMessage(message, type) {
            const logContainer = document.getElementById('realtimeLog');
            if (logContainer) {
                const colors = {
                    'success': 'text-green-400',
                    'error': 'text-red-400',
                    'info': 'text-blue-400',
                    'agent': 'text-purple-400',
                    'progress': 'text-yellow-400',
                    'feature': 'text-pink-400'
                };

                const logEntry = document.createElement('div');
                logEntry.className = `text-sm ${colors[type] || 'text-slate-300'} mb-1 font-mono fade-in`;
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        function updateAgentProgress(agent, status, progress, score) {
            state.agentProgress[agent] = { status, progress, score };
            updateProgressBars();
        }

        function updateProgressBars() {
            const progressContainer = document.getElementById('agentProgressContainer');
            if (!progressContainer) return;

            const agents = Object.keys(state.agentProgress);
            progressContainer.innerHTML = agents.map(agent => {
                const { status, progress, score } = state.agentProgress[agent];
                const statusEmoji = {
                    'generating': '‚è≥',
                    'improving': 'üîÑ',
                    'complete': '‚úÖ'
                };

                return `
                    <div class="bg-slate-900 bg-opacity-30 rounded-lg p-2">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-semibold text-purple-300">
                                ${statusEmoji[status] || '‚è≥'} ${agent.toUpperCase()}
                            </span>
                            ${score ? `<span class="text-xs text-green-400 font-bold">${score}</span>` : ''}
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden">
                            <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-1.5 rounded-full transition-all duration-500" 
                                 style="width: ${progress}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateLivePlansDisplay() {
            const plansContainer = document.getElementById('livePlansContainer');
            if (!plansContainer) return;

            const agents = Object.keys(state.liveAgentPlans);
            plansContainer.innerHTML = agents.map(agent => {
                const planData = state.liveAgentPlans[agent];
                return renderCompactAgentPlanCard(agent, planData);
            }).join('');
        }

        function renderCompactAgentPlanCard(agent, planData) {
            const statusIcons = {
                'generating': '‚è≥',
                'summarizing': 'üìã',
                'complete': '‚úÖ',
                'improving': 'üîÑ',
                'improved': 'üéØ'
            };

            const statusColors = {
                'generating': 'bg-yellow-500',
                'summarizing': 'bg-blue-500',
                'complete': 'bg-green-500',
                'improving': 'bg-purple-500',
                'improved': 'bg-pink-500'
            };

            const latestMiniPlan = planData.mini_plans.length > 0 ? 
                planData.mini_plans[planData.mini_plans.length - 1] : null;
            
            const latestSteps = latestMiniPlan?.steps || [];

            return `
                <div class="bg-slate-900 bg-opacity-40 rounded-lg p-3 mb-3 border border-slate-700">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full ${statusColors[planData.status]} bg-opacity-20 flex items-center justify-center text-sm">
                                <span>${statusIcons[planData.status]}</span>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-purple-300">${agent.toUpperCase()}</h4>
                                <p class="text-xs text-slate-500">${planData.status}</p>
                            </div>
                        </div>
                        ${planData.score ? `
                            <div class="px-2 py-1 bg-green-500 bg-opacity-20 rounded text-xs">
                                <span class="text-green-400 font-bold">${planData.score}</span>
                            </div>
                        ` : ''}
                    </div>

                    ${planData.mini_plans.length > 0 ? `
                        <div class="flex gap-2 text-xs text-slate-400 mb-2">
                            <span>üìã Group ${latestMiniPlan.group}/${planData.mini_plans.length}</span>
                            ${latestSteps.length > 0 ? `<span>‚Ä¢ üìù ${latestSteps.length} steps</span>` : ''}
                        </div>
                    ` : ''}

                    ${latestSteps.length > 0 ? `
                        <div class="bg-slate-800 bg-opacity-50 rounded-lg p-3 max-h-48 overflow-y-auto space-y-1.5">
                            <div class="text-xs font-semibold text-blue-400 mb-2 flex items-center gap-1">
                                <span>‚ö°</span>
                                <span>Latest Steps (Group ${latestMiniPlan.group})</span>
                            </div>
                            ${latestSteps.slice(0, 8).map((step, idx) => `
                                <div class="flex items-start gap-2 text-xs slide-up" style="animation-delay: ${idx * 0.05}s">
                                    <span class="text-purple-400 font-bold flex-shrink-0 mt-0.5">${idx + 1}.</span>
                                    <span class="text-slate-300 leading-relaxed">${step}</span>
                                </div>
                            `).join('')}
                            ${latestSteps.length > 8 ? `
                                <div class="text-xs text-slate-500 text-center mt-2">
                                    ... and ${latestSteps.length - 8} more steps
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="bg-slate-800 bg-opacity-30 rounded-lg p-3 text-center">
                            <div class="text-2xl mb-1 pulse-animate">‚è≥</div>
                            <p class="text-xs text-slate-400">Processing...</p>
                        </div>
                    `}
                </div>
            `;
        }

        function updateProcessingDisplay() {
            updateProgressBars();
            updateLivePlansDisplay();
            updateFeaturePanel();
            updateFraudPanel();
            updateSafetyNodesPanel();
            updateTechPanel();
        }

        // UPDATED PROCESSING PHASE WITH FRAUD DETECTION PANELS
        function renderProcessingPhase() {
            return `
                <div class="grid grid-cols-1 xl:grid-cols-5 gap-6">
                    <!-- Left Sidebar (1 column) -->
                    <div class="xl:col-span-1 space-y-4">
                        <div class="bg-slate-800 bg-opacity-50 backdrop-blur-lg rounded-xl p-4 border border-slate-700">
                            <div class="text-center mb-3">
                                <div class="text-3xl mb-2 pulse-animate">üß†</div>
                                <h2 class="text-lg font-bold mb-1">Processing</h2>
                                ${state.currentPhase ? `
                                    <div class="mt-2 px-3 py-1 bg-purple-500 bg-opacity-20 rounded-lg inline-block text-xs">
                                        <span class="text-purple-400 font-semibold">Phase ${state.currentPhase}</span>
                                    </div>
                                ` : ''}
                            </div>

                            <div id="agentProgressContainer" class="space-y-1.5">
                            </div>
                        </div>

                        <div class="bg-slate-800 bg-opacity-50 backdrop-blur-lg rounded-xl p-4 border border-slate-700 max-h-[600px] overflow-y-auto">
                            <h3 class="text-sm font-semibold text-slate-400 uppercase mb-3 flex items-center gap-2">
                                <span class="text-lg">üìã</span>
                                Mini Plans
                            </h3>
                            <div id="livePlansContainer" class="space-y-3">
                            </div>
                        </div>

                        <div class="bg-slate-800 bg-opacity-50 backdrop-blur-lg rounded-xl p-4 border border-slate-700">
                            <h3 class="text-xs font-semibold text-slate-400 uppercase mb-2 flex items-center gap-2">
                                <span class="w-2 h-2 bg-red-500 rounded-full pulse-animate"></span>
                                Activity Log
                            </h3>
                            <div id="realtimeLog" class="h-64 overflow-y-auto space-y-1 bg-slate-900 bg-opacity-30 rounded-lg p-2 scroll-smooth text-xs">
                            </div>
                        </div>
                    </div>

                    <!-- Center Area (2 columns) - Features -->
                    <div class="xl:col-span-2">
                        <div class="feature-panel bg-gradient-to-br from-pink-900 via-purple-900 to-slate-900 bg-opacity-60 backdrop-blur-xl rounded-2xl p-8 border-2 border-pink-500 border-opacity-40 shadow-2xl">
                            <div class="flex items-center justify-between mb-6 pb-4 border-b border-pink-500 border-opacity-30">
                                <div class="flex items-center gap-4">
                                    <div class="w-16 h-16 bg-gradient-to-br from-pink-500 to-purple-600 rounded-2xl flex items-center justify-center text-4xl shadow-lg">
                                        ‚ú®
                                    </div>
                                    <div>
                                        <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-purple-400">
                                            Features Discovery
                                        </h2>
                                        <p class="text-slate-300 text-sm mt-1">Real-time AI Feature Detection System</p>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="relative inline-block">
                                        <div class="text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-br from-pink-400 via-purple-400 to-pink-300" 
                                             id="featureCounter">${state.featureCount}</div>
                                        <div class="absolute -top-3 -right-8 text-green-400 font-bold text-2xl opacity-0 transition-opacity animate-bounce" 
                                             id="featureAdded" style="transition: opacity 0.3s;">+0</div>
                                    </div>
                                    <div class="text-slate-400 text-sm mt-1">Total Features</div>
                                </div>
                            </div>

                            <div class="grid grid-cols-4 gap-4 mb-6">
                                <div class="bg-slate-900 bg-opacity-40 rounded-xl p-4 border border-pink-500 border-opacity-20">
                                    <div class="text-2xl mb-1">üéØ</div>
                                    <div class="text-2xl font-bold text-pink-400" id="featureCountMain">${state.featureCount}</div>
                                    <div class="text-xs text-slate-400">Discovered</div>
                                </div>
                                <div class="bg-slate-900 bg-opacity-40 rounded-xl p-4 border border-purple-500 border-opacity-20">
                                    <div class="text-2xl mb-1">üìç</div>
                                    <div class="text-2xl font-bold text-purple-400" id="fromAimCount">0</div>
                                    <div class="text-xs text-slate-400">From Aim</div>
                                </div>
                                <div class="bg-slate-900 bg-opacity-40 rounded-xl p-4 border border-blue-500 border-opacity-20">
                                    <div class="text-2xl mb-1">ü§ñ</div>
                                    <div class="text-2xl font-bold text-blue-400" id="fromAICount">0</div>
                                    <div class="text-xs text-slate-400">From AI Plans</div>
                                </div>
                                <div class="bg-slate-900 bg-opacity-40 rounded-xl p-4 border border-green-500 border-opacity-20">
                                    <div class="text-2xl mb-1">‚ö°</div>
                                    <div class="text-2xl font-bold text-green-400" id="recentCount">0</div>
                                    <div class="text-xs text-slate-400">Recent (30s)</div>
                                </div>
                            </div>

                            <div id="featureList" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-[700px] overflow-y-auto scroll-smooth pr-3">
                            </div>
                        </div>
                    </div>

                    <!-- Right Sidebar (2 columns) - Fraud & Tech -->
                    <div class="xl:col-span-2 space-y-4">
                        <!-- Fraud Detection Panel -->
                        <div class="bg-gradient-to-br from-red-900 via-slate-900 to-slate-900 bg-opacity-60 backdrop-blur-xl rounded-2xl p-6 border-2 border-red-500 border-opacity-40 shadow-2xl">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-pink-600 rounded-xl flex items-center justify-center text-3xl">
                                        üõ°Ô∏è
                                    </div>
                                    <div>
                                        <h2 class="text-2xl font-bold text-red-300">Fraud Detection</h2>
                                        <p class="text-slate-400 text-xs">Real-time security monitoring</p>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="text-4xl font-bold text-red-400" id="fraudAlertCounter">${state.fraudAlertCount}</div>
                                    <div class="text-xs text-slate-400">Alerts</div>
                                </div>
                            </div>
                            <div id="fraudDetectionList" class="space-y-3 max-h-96 overflow-y-auto scroll-smooth">
                            </div>
                        </div>

                        <!-- Safety Nodes Panel -->
                        <div class="bg-gradient-to-br from-blue-900 via-slate-900 to-slate-900 bg-opacity-60 backdrop-blur-xl rounded-2xl p-6 border-2 border-blue-500 border-opacity-40">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-blue-500 bg-opacity-20 rounded-xl flex items-center justify-center text-2xl">üîí</div>
                                <div>
                                    <h3 class="text-xl font-bold text-blue-300">Safety Nodes Generated</h3>
                                    <p class="text-slate-400 text-xs">Automatic protection systems</p>
                                </div>
                            </div>
                            <div id="safetyNodesList" class="space-y-3 max-h-64 overflow-y-auto scroll-smooth">
                            </div>
                        </div>

                        <!-- Tech Integration Panel -->
                        <div class="bg-gradient-to-br from-purple-900 via-slate-900 to-slate-900 bg-opacity-60 backdrop-blur-xl rounded-2xl p-6 border-2 border-purple-500 border-opacity-40">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-purple-500 bg-opacity-20 rounded-xl flex items-center justify-center text-2xl">üîß</div>
                                <div>
                                    <h3 class="text-xl font-bold text-purple-300">Tech Integration</h3>
                                    <p class="text-slate-400 text-xs">Automation suggestions</p>
                                </div>
                            </div>
                            <div id="techSuggestionsList" class="space-y-3 max-h-96 overflow-y-auto scroll-smooth">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function handleLogin(e) {
            e.preventDefault();
            setState({ isLoading: true });

            try {
                const response = await fetch('http://localhost:5000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: state.username,
                        password: state.password
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    setState({
                        currentUser: data.username,
                        isAuthenticated: true,
                        password: '',
                        isLoading: false
                    });
                } else {
                    alert(data.message || 'Invalid credentials');
                    setState({ isLoading: false });
                }
            } catch (error) {
                alert('Unable to connect to server');
                setState({ isLoading: false });
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            setState({ isLoading: true });

            try {
                const response = await fetch('http://localhost:5000/api/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: state.username,
                        email: state.email,
                        password: state.password
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert('Account created! Please login.');
                    setState({
                        showLogin: true,
                        username: '',
                        password: '',
                        email: '',
                        isLoading: false
                    });
                } else {
                    alert(data.message || 'Signup failed');
                    setState({ isLoading: false });
                }
            } catch (error) {
                alert('Unable to connect to server');
                setState({ isLoading: false });
            }
        }

        function handleLogout() {
            setState({
                isAuthenticated: false,
                currentUser: null,
                username: '',
                password: '',
                email: '',
                phase: 'input',
                aim: '',
                steps: { step1: '', step2: '' },
                apiResponse: null,
                liveAgentPlans: {},
                analyticsData: {},
                discoveredFeatures: [],
                featureCount: 0,
                naturalLanguageInput: '',
                showConfirmation: false,
                fraudDetections: [],
                fraudAlertCount: 0,
                techSuggestions: [],
                safetyNodes: [],
                toolName: '',
                isToolProcessing: false,
                activeTool: null,
                showToolInput: false
            });
        }

        function addStep() {
            const stepKeys = Object.keys(state.steps);
            const nextStepNum = stepKeys.length + 1;
            state.steps['step' + nextStepNum] = '';
            render();
        }

        function removeStep(key) {
            const newSteps = { ...state.steps };
            delete newSteps[key];

            const stepValues = Object.values(newSteps);
            const renumberedSteps = {};
            stepValues.forEach((value, index) => {
                renumberedSteps['step' + (index + 1)] = value;
            });

            state.steps = Object.keys(renumberedSteps).length > 0 ? renumberedSteps : { step1: '' };
            render();
        }

        function getWinner() {
            if (!state.apiResponse) return null;

            const agents = Object.keys(state.apiResponse).filter(key => key.startsWith('agent'));
            let winner = null;
            let maxAvg = -1;

            agents.forEach(agentKey => {
                const agent = state.apiResponse[agentKey];
                const avg = agent.average_score || 0;

                if (avg > maxAvg) {
                    maxAvg = avg;
                    winner = { ...agent, agentKey, avgScore: avg };
                }
            });

            return winner;
        }

        function reset() {
            setState({
                phase: 'input',
                aim: '',
                steps: { step1: '', step2: '' },
                apiResponse: null,
                liveAgentPlans: {},
                analyticsData: {},
                discoveredFeatures: [],
                featureCount: 0,
                naturalLanguageInput: '',
                showConfirmation: false,
                fraudDetections: [],
                fraudAlertCount: 0,
                techSuggestions: [],
                safetyNodes: [],
                toolName: '',
                isToolProcessing: false,
                activeTool: null,
                showToolInput: false
            });
        }

        function render() {
            const app = document.getElementById('app');
            
            if (!state.isAuthenticated) {
                app.innerHTML = renderAuthScreen();
            } else {
                app.innerHTML = renderMainApp();
            }
            
            attachEventListeners();
        }

        function renderAuthScreen() {
            return `
                <div class="min-h-screen flex items-center justify-center p-8 text-white">
                    <div class="w-full max-w-md">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-purple-500 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl">üß†</div>
                            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-2">AI Planner</h1>
                            <p class="text-slate-400">Feature Detection + Fraud Detection System</p>
                        </div>

                        <div class="bg-slate-800 bg-opacity-50 backdrop-blur-lg rounded-2xl p-8 border border-slate-700 shadow-2xl">
                            <div class="flex gap-2 mb-6">
                                <button onclick="setState({ showLogin: true })" class="flex-1 py-2 rounded-lg font-semibold transition-all ${state.showLogin ? 'bg-purple-600 text-white' : 'bg-slate-700 bg-opacity-50 text-slate-400'}">
                                    Login
                                </button>
                                <button onclick="setState({ showLogin: false })" class="flex-1 py-2 rounded-lg font-semibold transition-all ${!state.showLogin ? 'bg-purple-600 text-white' : 'bg-slate-700 bg-opacity-50 text-slate-400'}">
                                    Sign Up
                                </button>
                            </div>

                            <form id="authForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-slate-300">Username</label>
                                    <input type="text" id="username" value="${state.username}" required class="w-full px-4 py-3 bg-slate-900 bg-opacity-50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter username" />
                                </div>

                                ${!state.showLogin ? `
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-slate-300">Email</label>
                                    <input type="email" id="email" value="${state.email}" required class="w-full px-4 py-3 bg-slate-900 bg-opacity-50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter email" />
                                </div>
                                ` : ''}

                                <div>
                                    <label class="block text-sm font-medium mb-2 text-slate-300">Password</label>
                                    <input type="password" id="password" value="${state.password}" required class="w-full px-4 py-3 bg-slate-900 bg-opacity-50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter password" />
                                </div>

                                <button type="submit" ${state.isLoading ? 'disabled' : ''} class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 disabled:from-slate-600 disabled:to-slate-600 rounded-xl font-semibold transition-all shadow-lg">
                                    ${state.isLoading ? 'Processing...' : state.showLogin ? 'Login' : 'Sign Up'}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainApp() {
            return `
                <div class="p-8">
                    <div class="max-w-7xl mx-auto text-white">
                        <div class="flex items-center justify-between mb-8 flex-wrap gap-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center text-2xl">üß†</div>
                                <div>
                                    <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">AI Collaborative Planner</h1>
                                    <p class="text-slate-400 text-sm">Feature Detection + Fraud Detection + Real-time Generation</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2 px-4 py-2 bg-slate-800 bg-opacity-50 rounded-lg border border-slate-700">
                                    <span class="text-2xl">üë§</span>
                                    <span class="text-slate-300">${state.currentUser}</span>
                                </div>
                                <button onclick="handleLogout()" class="flex items-center gap-2 px-4 py-2 bg-red-500 bg-opacity-20 hover:bg-opacity-30 rounded-lg transition-colors text-red-400">
                                    <span>Logout</span>
                                </button>
                            </div>
                        </div>

                        ${state.showConfirmation ? renderConfirmationScreen() : ''}
                        ${!state.showConfirmation && state.phase === 'input' ? renderInputPhase() : ''}
                        ${!state.showConfirmation && state.phase === 'processing' ? renderProcessingPhase() : ''}
                        ${!state.showConfirmation && state.phase === 'results' ? renderResultsPhase() : ''}
                    </div>
                </div>
            `;
        }

        function renderInputPhase() {
            const isAimValid = state.aim.trim().length > 0;
            const areStepsValid = Object.values(state.steps).every(s => s.trim().length > 0);
            const isFormValid = isAimValid && areStepsValid;
            
            return `
                <div class="space-y-6">
                    ${state.activeTool ? `
                        <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-xl p-4 border-2 border-blue-400 border-opacity-50 shadow-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-blue-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                                        <span class="text-2xl">üîß</span>
                                    </div>
                                    <div>
                                        <div class="text-xs text-blue-300 font-semibold uppercase">Active Tool</div>
                                        <div class="text-blue-200 font-bold text-xl">${state.activeTool.name}</div>
                                        <div class="text-blue-400 text-xs mt-0.5">Parameters loaded and ready</div>
                                    </div>
                                </div>
                                <button 
                                    onclick="removeTool()"
                                    class="group w-10 h-10 bg-red-500 bg-opacity-10 hover:bg-opacity-30 rounded-lg flex items-center justify-center transition-all border border-red-500 border-opacity-30 hover:border-opacity-60"
                                    title="Remove tool and clear data"
                                >
                                    <span class="text-red-400 group-hover:text-red-300 text-xl font-bold">‚úï</span>
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    <div class="bg-gradient-to-br from-blue-900 via-purple-900 to-slate-900 bg-opacity-50 backdrop-blur-lg rounded-2xl p-8 border-2 border-blue-500 border-opacity-30 shadow-2xl">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="text-4xl">üß†</span>
                            <div>
                                <h2 class="text-2xl font-bold text-blue-300">Quick Start: Natural Language</h2>
                                <p class="text-slate-400 text-sm">Describe your goal in plain words, and AI will structure it for you</p>
                            </div>
                        </div>
                        
                        <textarea 
                            id="naturalLanguageInput" 
                            placeholder="Example: I want to create a mobile app that helps people track their daily water intake..."
                            class="w-full h-32 px-6 py-4 bg-slate-900 bg-opacity-50 border border-slate-600 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg resize-none"
                            ${state.isLoading ? 'disabled' : ''}
                        ></textarea>
                        
                        <div class="flex items-center gap-3 mt-4">
                            <button 
                                id="parseButton"
                                onclick="parseNaturalLanguage()" 
                                ${state.isLoading ? 'disabled' : ''}
                                class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 disabled:from-slate-600 disabled:to-slate-600 rounded-xl font-semibold transition-all shadow-lg"
                            >
                                <span class="text-xl">‚ú®</span>
                                <span id="parseButtonText">Convert to AIM + Steps</span>
                            </button>
                            
                            <span class="text-slate-400 text-sm">or fill the form below manually</span>
                        </div>
                    </div>

                    <!-- NEW TOOL INPUT SECTION -->
                    <div class="bg-gradient-to-br from-purple-900 via-indigo-900 to-slate-900 bg-opacity-50 backdrop-blur-lg rounded-2xl p-8 border-2 border-purple-500 border-opacity-30 shadow-2xl">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center shadow-lg">
                                    <span class="text-3xl">üîß</span>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-pink-300">Software Tool Integration</h2>
                                    <p class="text-slate-400 text-sm">Add a tool to enhance planning with tool-specific parameters</p>
                                </div>
                            </div>
                            <button 
                                onclick="toggleToolInput()"
                                class="px-4 py-2 ${state.showToolInput ? 'bg-slate-700 hover:bg-slate-600' : 'bg-purple-600 hover:bg-purple-700'} rounded-lg text-sm font-semibold transition-all flex items-center gap-2"
                            >
                                <span>${state.showToolInput ? '‚ñº' : '‚ñ∂'}</span>
                                <span>${state.showToolInput ? 'Hide' : 'Add Tool'}</span>
                            </button>
                        </div>
                        
                        ${state.showToolInput ? `
                            <div class="space-y-4 slide-up">
                                <div>
                                    <label class="block text-sm font-semibold text-purple-300 mb-2">
                                        üéØ Enter Software/Tool Name
                                    </label>
                                    <input 
                                        type="text" 
                                        id="toolNameInput" 
                                        value="${state.toolName}"
                                        placeholder="e.g., Adobe Photoshop, Figma, Microsoft Excel, Blender..." 
                                        class="w-full px-5 py-4 bg-slate-900 bg-opacity-60 border-2 border-purple-500 border-opacity-30 focus:border-opacity-60 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg transition-all"
                                        ${state.isToolProcessing ? 'disabled' : ''}
                                    />
                                    <p class="text-xs text-slate-500 mt-2">
                                        üí° Enter any software name to automatically extract its tools, features, and parameters
                                    </p>
                                </div>
                                
                                <button 
                                    onclick="processTool()"
                                    ${state.isToolProcessing || !state.toolName.trim() ? 'disabled' : ''}
                                    class="w-full py-4 bg-gradient-to-r from-purple-600 via-pink-600 to-purple-600 hover:from-purple-700 hover:via-pink-700 hover:to-purple-700 disabled:from-slate-600 disabled:to-slate-600 disabled:cursor-not-allowed rounded-xl font-bold text-lg transition-all shadow-xl flex items-center justify-center gap-3"
                                >
                                    ${state.isToolProcessing ? `
                                        <div class="w-5 h-5 border-3 border-white border-t-transparent rounded-full animate-spin"></div>
                                        <span>Processing Tool...</span>
                                    ` : `
                                        <span class="text-2xl">‚ú®</span>
                                        <span>Extract Tools & Parameters</span>
                                    `}
                                </button>
                                
                                ${state.isToolProcessing ? `
                                    <div class="bg-yellow-500 bg-opacity-10 border-2 border-yellow-500 border-opacity-30 rounded-xl p-4">
                                        <div class="flex items-start gap-3">
                                            <div class="w-6 h-6 border-3 border-yellow-400 border-t-transparent rounded-full animate-spin flex-shrink-0 mt-0.5"></div>
                                            <div>
                                                <p class="text-yellow-300 font-semibold mb-1">üîç Extracting Tool Information...</p>
                                                <p class="text-yellow-200 text-sm">
                                                    This process discovers all tools, features, menus, and parameters from the software.
                                                </p>
                                                <p class="text-yellow-400 text-xs mt-2">
                                                    ‚è±Ô∏è This may take 2-5 minutes depending on the software complexity.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="bg-blue-500 bg-opacity-10 border border-blue-500 border-opacity-30 rounded-xl p-4">
                                    <div class="flex items-start gap-3">
                                        <span class="text-2xl flex-shrink-0">üí°</span>
                                        <div class="text-sm">
                                            <p class="text-blue-300 font-semibold mb-2">How it works:</p>
                                            <ol class="text-slate-300 space-y-1 list-decimal list-inside">
                                                <li>AI identifies all tools and features in the software</li>
                                                <li>Extracts parameters from each tool</li>
                                                <li>Saves everything to Excel files for planning</li>
                                                <li>Parameters are automatically merged during plan generation</li>
                                            </ol>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div class="flex items-center gap-4">
                        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-slate-600 to-transparent"></div>
                        <span class="text-slate-500 text-sm font-semibold">OR ENTER MANUALLY</span>
                        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-slate-600 to-transparent"></div>
                    </div>

                    <div class="bg-slate-800 bg-opacity-50 backdrop-blur-lg rounded-2xl p-8 border border-slate-700 shadow-2xl">
                        <div class="mb-8">
                            <label class="flex items-center gap-2 text-xl font-semibold mb-3">
                                <span class="text-2xl">üéØ</span>
                                Your Goal
                            </label>
                            <input 
                                type="text" 
                                id="aim" 
                                value="${state.aim}" 
                                placeholder="Enter your main objective..." 
                                class="w-full px-6 py-4 bg-slate-900 bg-opacity-50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg" 
                                ${state.isLoading ? 'disabled' : ''}
                            />
                        </div>

                        <div class="mb-8">
                            <label class="flex items-center gap-2 text-xl font-semibold mb-3">
                                <span class="text-2xl">‚û°Ô∏è</span>
                                Initial Steps
                            </label>
                            <div id="stepsContainer">
                                ${Object.entries(state.steps).map(([key, value], index) => `
                                    <div class="flex gap-3 mb-3">
                                        <input 
                                            type="text" 
                                            data-step-key="${key}" 
                                            value="${value}" 
                                            placeholder="Step ${index + 1}..." 
                                            class="flex-1 px-6 py-3 bg-slate-900 bg-opacity-50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500" 
                                            ${state.isLoading ? 'disabled' : ''}
                                        />
                                        ${Object.keys(state.steps).length > 1 ? `
                                            <button 
                                                onclick="removeStep('${key}')" 
                                                class="px-4 py-3 bg-red-500 bg-opacity-20 hover:bg-opacity-30 rounded-xl transition-colors text-red-400 font-bold"
                                                ${state.isLoading ? 'disabled' : ''}
                                            >
                                                ‚úï
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <button 
                                onclick="addStep()" 
                                class="flex items-center gap-2 px-6 py-3 bg-purple-500 bg-opacity-20 hover:bg-opacity-30 rounded-xl transition-colors text-purple-300"
                                ${state.isLoading ? 'disabled' : ''}
                            >
                                <span class="text-xl">‚ûï</span>
                                Add Step
                            </button>
                        </div>

                        <button 
                            id="planButton" 
                            onclick="startPlanning()" 
                            ${!isFormValid || state.isLoading ? 'disabled' : ''} 
                            class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 disabled:from-slate-600 disabled:to-slate-600 disabled:cursor-not-allowed rounded-xl font-semibold text-lg transition-all shadow-lg"
                        >
                            ${state.isLoading ? '‚è≥ Processing...' : '‚ú® Start AI Planning'}
                        </button>
                        <p id="errorMsg" style="display: ${isFormValid ? 'none' : 'block'}" class="text-sm text-red-400 mt-2 text-center">
                            Please fill all fields to continue
                        </p>
                    </div>
                </div>
            `;
        }

        function renderResultsPhase() {
            const winner = getWinner();
            const agents = Object.keys(state.apiResponse || {}).filter(key => key.startsWith('agent'));

            return `
                <div class="space-y-6">
                    ${winner ? `
                        <div class="bg-gradient-to-r from-yellow-500 from-opacity-20 to-orange-500 to-opacity-20 backdrop-blur-lg rounded-2xl p-8 border border-yellow-500 border-opacity-30 shadow-2xl">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">üèÜ</div>
                                <h2 class="text-4xl font-bold mb-2">Winner: ${winner.agent_name ? winner.agent_name.toUpperCase() : 'AI Agent ' + winner.agentKey.replace('agent', '')}</h2>
                                <p class="text-3xl text-yellow-400 font-bold mb-4">Average Score: ${winner.avgScore.toFixed(1)}</p>
                                <p class="text-slate-400">Original: ${winner.original_score} ‚Üí Final: ${winner.final_score} (${winner.total_improvements} improvements)</p>
                            </div>

                            <div class="bg-slate-900 bg-opacity-50 rounded-xl p-6 mt-6">
                                <h3 class="text-xl font-semibold mb-4 text-yellow-400">Winning Plan Steps:</h3>
                                <div class="space-y-3">
                                    ${Object.entries(winner.steps || {}).map(([key, step], idx) => `
                                        <div class="flex items-start gap-3">
                                            <div class="w-8 h-8 rounded-full bg-yellow-500 bg-opacity-20 flex items-center justify-center flex-shrink-0">
                                                <span class="text-yellow-400 font-bold">${idx + 1}</span>
                                            </div>
                                            <span class="text-slate-200 text-lg">${step}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    ${state.discoveredFeatures.length > 0 ? `
                        <div class="bg-gradient-to-br from-pink-900 via-purple-900 to-slate-900 bg-opacity-50 backdrop-blur-lg rounded-2xl p-8 border border-pink-500 border-opacity-30">
                            <div class="flex items-center gap-3 mb-6">
                                <span class="text-5xl">‚ú®</span>
                                <div>
                                    <h2 class="text-3xl font-bold text-pink-300">Features Discovered</h2>
                                    <p class="text-slate-400">Total: ${state.featureCount} features identified</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                ${state.discoveredFeatures.map((featureObj, index) => {
                                    const feature = featureObj.feature || featureObj;
                                    const source = featureObj.source || 'unknown';
                                    const sourceColor = source.includes('aim') ? 'purple' : source.includes('mini_plan') ? 'blue' : 'pink';
                                    return `
                                        <div class="bg-gradient-to-r from-${sourceColor}-500 to-pink-500 bg-opacity-10 border border-${sourceColor}-500 border-opacity-30 rounded-lg px-4 py-3">
                                            <div class="flex items-center gap-2">
                                                <span class="text-${sourceColor}-400 font-bold text-lg">‚Ä¢</span>
                                                <span class="text-slate-100 font-medium text-sm">${typeof feature === 'string' ? feature : feature.text || 'Unknown'}</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        ${agents.map(agentKey => {
                            const agentData = state.apiResponse[agentKey];
                            const avgScore = agentData.average_score || 0;
                            const isWinner = winner && winner.agentKey === agentKey;
                            
                            return `
                                <div class="bg-slate-800 bg-opacity-50 backdrop-blur-lg rounded-xl p-6 border ${isWinner ? 'border-yellow-500 ring-2 ring-yellow-500 ring-opacity-50' : 'border-slate-700'}">
                                    <div class="flex items-center justify-between mb-4">
                                        <div>
                                            <h3 class="font-semibold text-lg">${agentData.agent_name ? agentData.agent_name.toUpperCase() : 'Agent ' + agentKey.replace('agent', '')}</h3>
                                            <p class="text-sm text-slate-400">AI Agent ${agentKey.replace('agent', '')}</p>
                                        </div>
                                        ${isWinner ? '<span class="text-2xl">üèÜ</span>' : ''}
                                    </div>
                                    
                                    <div class="mb-4">
                                        <div class="text-3xl font-bold mb-2">
                                            <span class="text-purple-400">${avgScore.toFixed(1)}</span>
                                            <span class="text-sm text-slate-400 ml-2">avg score</span>
                                        </div>
                                        <div class="text-sm text-slate-400">
                                            Original: ${agentData.original_score} ‚Üí Final: ${agentData.final_score}
                                            <span class="text-green-400 ml-2">+${agentData.final_score - agentData.original_score}</span>
                                        </div>
                                    </div>

                                    <div class="mb-4">
                                        <h4 class="text-xs font-semibold text-slate-500 uppercase mb-2">Action Plan (${Object.keys(agentData.steps || {}).length} steps):</h4>
                                        <div class="space-y-2 max-h-60 overflow-y-auto">
                                            ${Object.entries(agentData.steps || {}).map(([key, step], idx) => `
                                                <div class="text-sm text-slate-300 flex items-start gap-2 bg-slate-900 bg-opacity-30 p-2 rounded">
                                                    <span class="text-purple-400 font-bold flex-shrink-0">${idx + 1}.</span>
                                                    <span>${step}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <div class="space-y-2">
                                        <h4 class="text-xs font-semibold text-slate-500 uppercase">Score Progress:</h4>
                                        <div class="flex flex-wrap gap-2">
                                            ${(agentData.all_improvement_scores || []).map((score, idx) => `
                                                <div class="px-3 py-1 bg-slate-900 bg-opacity-50 rounded-lg text-sm">
                                                    <span class="text-slate-400">${idx === 0 ? 'Orig' : `R${idx}`}:</span>
                                                    <span class="ml-2 font-bold text-purple-400">${score}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <button onclick="reset()" class="w-full py-4 bg-slate-700 hover:bg-slate-600 rounded-xl font-semibold text-lg transition-all">
                        ‚ö° Start New Plan
                    </button>
                </div>
            `;
        }

        function toggleToolInput() {
            setState({ showToolInput: !state.showToolInput });
        }

        async function processTool() {
            const toolName = document.getElementById('toolNameInput')?.value.trim();
            
            if (!toolName) {
                alert('Please enter a tool name');
                return;
            }
            
            setState({ isToolProcessing: true });
            
            try {
                const response = await fetch('http://localhost:5000/api/process-tool', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        tool_name: toolName 
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    setState({
                        activeTool: {
                            name: toolName,
                            toolPath: data.tool_path,
                            paramPath: data.param_path
                        },
                        toolName: '',
                        showToolInput: false,
                        isToolProcessing: false
                    });
                    
                    // Save to cookies
                    document.cookie = `activeTool=${JSON.stringify(state.activeTool)}; path=/; max-age=86400`;
                    
                    alert(`‚úÖ Tool "${toolName}" processed successfully!\n${data.tools_found} tools and ${data.parameters_found} parameters extracted.`);
                } else {
                    alert('‚ùå ' + (data.message || 'Failed to process tool'));
                    setState({ isToolProcessing: false });
                }
                
            } catch (error) {
                console.error('Tool processing error:', error);
                alert('‚ùå Unable to connect to server');
                setState({ isToolProcessing: false });
            }
        }

        async function removeTool() {
            if (!confirm('Remove this tool? This will clear all extracted data.')) {
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/remove-tool', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        tool_path: state.activeTool.toolPath,
                        param_path: state.activeTool.paramPath
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    setState({ activeTool: null });
                    document.cookie = 'activeTool=; path=/; max-age=0';
                    alert('‚úÖ Tool removed and data cleared');
                } else {
                    alert('‚ö†Ô∏è ' + (data.message || 'Failed to remove tool'));
                }
                
            } catch (error) {
                console.error('Remove tool error:', error);
                alert('‚ùå Unable to remove tool');
            }
        }

        // Load active tool from cookies on page load
        function loadToolFromCookies() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'activeTool' && value) {
                    try {
                        state.activeTool = JSON.parse(decodeURIComponent(value));
                    } catch (e) {
                        console.error('Error loading tool from cookies:', e);
                    }
                }
            }
        }

        function attachEventListeners() {
            const authForm = document.getElementById('authForm');
            if (authForm) {
                authForm.onsubmit = state.showLogin ? handleLogin : handleSignup;
            }

            const usernameInput = document.getElementById('username');
            if (usernameInput) {
                usernameInput.oninput = (e) => {
                    state.username = e.target.value;
                };
            }

            const emailInput = document.getElementById('email');
            if (emailInput) {
                emailInput.oninput = (e) => {
                    state.email = e.target.value;
                };
            }

            const passwordInput = document.getElementById('password');
            if (passwordInput) {
                passwordInput.oninput = (e) => {
                    state.password = e.target.value;
                };
            }

            const aimInput = document.getElementById('aim');
            if (aimInput) {
                aimInput.oninput = (e) => {
                    state.aim = e.target.value;
                    updateButtonState();
                };
            }

            const stepInputs = document.querySelectorAll('[data-step-key]');
            stepInputs.forEach(input => {
                input.oninput = (e) => {
                    const key = e.target.getAttribute('data-step-key');
                    state.steps[key] = e.target.value;
                    updateButtonState();
                };
            });
            
            // NEW: Tool name input listener
            const toolInput = document.getElementById('toolNameInput');
            if (toolInput) {
                toolInput.oninput = (e) => {
                    state.toolName = e.target.value;
                };
            }
        }

        function updateButtonState() {
            const button = document.querySelector('#planButton');
            const errorMsg = document.querySelector('#errorMsg');
            
            if (button && errorMsg) {
                const isAimValid = state.aim.trim().length > 0;
                const areStepsValid = Object.values(state.steps).every(s => s.trim().length > 0);
                const isFormValid = isAimValid && areStepsValid;
                
                button.disabled = !isFormValid || state.isLoading;
                errorMsg.style.display = isFormValid ? 'none' : 'block';
            }
        }

        // Load tool on page load
        loadToolFromCookies();
        document.addEventListener('DOMContentLoaded', render);
        render();
    </script>
</body>
</html>
